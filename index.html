<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4f46e5">
    <title>Nexus ERP v30.0 - Guest & Edit</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root { 
            --primary-gradient: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            --bg-body: #f8f9fa; --surface: #ffffff;
            --text-main: #1f2937; --radius: 16px; 
            --shadow: 0 10px 25px -5px rgba(0,0,0,0.05), 0 8px 10px -6px rgba(0,0,0,0.01);
        }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-body); overflow-x: hidden; color: var(--text-main); -webkit-tap-highlight-color: transparent; }
        
        /* SIDEBAR */
        .sidebar { 
            position: fixed; top: 0; left: 0; bottom: 0;
            width: 260px; background: var(--primary-gradient); color: white; 
            z-index: 1000; box-shadow: 5px 0 15px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; transition: 0.3s;
        }
        .sidebar-menu { flex: 1; overflow-y: auto; overflow-x: hidden; padding-top: 10px; }
        .sidebar-footer { flex: 0 0 auto; padding: 20px 15px; background: rgba(0,0,0,0.15); }
        .nav-link { color: rgba(255,255,255,0.85); margin: 4px 15px; border-radius: 12px; transition: 0.2s; padding: 12px 15px; display: flex; align-items: center; font-weight: 500; cursor: pointer; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.25); color: white; transform: translateX(5px); font-weight: 700; }
        .nav-link i { width: 25px; text-align: center; margin-right: 10px; font-size: 1.1em; }

        main { margin-left: 260px; padding: 30px; min-height: 100vh; }
        
        /* UI Elements */
        .card-custom { border: none; border-radius: var(--radius); background: var(--surface); box-shadow: var(--shadow); overflow: hidden; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); cursor: default; }
        .card-active { cursor: pointer; }
        .card-active:hover { transform: translateY(-5px) scale(1.01); box-shadow: 0 20px 30px -10px rgba(79, 70, 229, 0.15); }
        .icon-box { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        
        .scroll-box { max-height: 300px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #cbd5e1 #f1f5f9; }
        .scroll-box::-webkit-scrollbar { width: 6px; }
        .scroll-box::-webkit-scrollbar-track { background: #f1f5f9; }
        .scroll-box::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        
        .alert-item-click { cursor: pointer; transition: background 0.2s; }
        .alert-item-click:hover { filter: brightness(0.95); }

        .bg-green-soft { background-color: #d1fae5; color: #065f46; }
        .bg-red-soft { background-color: #fee2e2; color: #991b1b; }
        .bg-blue-soft { background-color: #dbeafe; color: #1e40af; }
        .bg-orange-soft { background-color: #ffedd5; color: #c2410c; }
        .bg-warning-soft { background-color: #fef3c7; color: #92400e; }
        .bg-danger-soft { background-color: #fee2e2; color: #991b1b; }

        /* Loader & Login Moderno */
        #global-loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:10000; display:flex; justify-content:center; align-items:center; }
        
        #login-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); 
            z-index: 9999; display: flex; align-items: center; justify-content: center; 
        }
        .login-box { 
            background: rgba(255, 255, 255, 0.85); 
            backdrop-filter: blur(12px); 
            padding: 50px; 
            border-radius: 30px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); 
            width: 100%; max-width: 450px; text-align: center; 
            border: 1px solid rgba(255,255,255,0.5);
        }

        /* Classes para Modo Visitante */
        body.guest-mode .admin-only { display: none !important; }
        .guest-banner { display: none; position: fixed; bottom: 20px; right: 20px; background: #212529; color: white; padding: 10px 20px; border-radius: 50px; z-index: 10000; font-weight: bold; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        body.guest-mode .guest-banner { display: block; }

        /* Mobile */
        @media (max-width: 768px) {
            .sidebar { left: -280px; width: 260px; }
            .sidebar.show { left: 0; }
            main { margin-left: 0; padding-top: 80px !important; }
            .mobile-header { display: flex !important; justify-content: space-between; padding: 15px 20px; background: var(--primary-gradient); color: white; align-items: center; position: fixed; top:0; left:0; width:100%; z-index:900; }
            .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; backdrop-filter: blur(2px); }
            .overlay.show { display: block; }
        }
        .mobile-header { display: none; }
        .hide { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }

        /* PDV Updates */
        .pdv-product-card { cursor: pointer; border: 1px solid #f3f4f6; border-radius: 12px; transition: 0.2s; }
        .pdv-product-card:hover { border-color: #6366f1; background-color: #f5f3ff; }
        .cart-area { background: var(--surface); border-radius: var(--radius); box-shadow: var(--shadow); height: calc(100vh - 100px); display: flex; flex-direction: column; position: sticky; top: 20px; }
        @media (max-width: 768px) { .cart-area { height: auto; min-height: 400px; position: relative; top: 0; margin-top: 20px; } }
        .qty-input-field { width: 45px; text-align: center; border: 1px solid #dee2e6; border-radius: 6px; margin: 0 5px; padding: 2px; font-weight: bold; font-size: 0.9rem; background: white; color: var(--text-main); }
        .btn-pagamento { border: 2px solid #e5e7eb; border-radius: 15px; padding: 15px; transition: all 0.2s; text-align: center; background: white; width: 100%; height: 100%; cursor: pointer; }
        .btn-pagamento.active { border-color: #4f46e5; background-color: #eef2ff; color: #4f46e5; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2); }
        .toggle-desc { cursor: pointer; user-select: none; width: 40px; text-align: center; font-weight: bold; }
        .toggle-desc.active { background-color: #4f46e5; color: white; border-color: #4f46e5; }
        
        /* CHAT IA */
        .chat-container { height: 400px; overflow-y: auto; background: #f3f4f6; border-radius: 12px; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .chat-msg { max-width: 85%; padding: 10px 15px; border-radius: 15px; font-size: 0.95rem; line-height: 1.4; }
        .chat-user { align-self: flex-end; background: #4f46e5; color: white; border-bottom-right-radius: 2px; }
        .chat-bot { align-self: flex-start; background: white; border: 1px solid #e5e7eb; border-bottom-left-radius: 2px; }
        .mic-btn { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .mic-listening { animation: pulse 1.5s infinite; background-color: #ef4444 !important; border-color: #ef4444 !important; color: white !important; }

        /* IMPRESS√ÉO */
        @media print {
            body * { visibility: hidden; }
            #area-impressao, #area-impressao * { visibility: visible; }
            #area-impressao { position: absolute; left: 0; top: 0; width: 100%; background: white; color: black; display: flex; justify-content: center; padding-top: 20px; }
            @page { margin: 0; size: auto; }
            .cupom-fiscal { width: 80mm; font-family: 'Courier Prime', monospace; font-size: 12px; text-align: left; }
            .cupom-fiscal h4 { text-align: center; }
            .cupom-divider { border-top: 1px dashed black; margin: 5px 0; }
            .cupom-row { display: flex; justify-content: space-between; }
            .cupom-total { font-size: 14px; font-weight: bold; }
        }
    </style>
</head>
<body>

<div id="global-loader" class="hide"><div class="text-center"><div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div><p class="mt-2 fw-bold text-muted blink">Carregando Nexus...</p></div></div>

<div id="login-screen">
    <div class="login-box fade-in">
        <div class="mb-4">
            <div class="bg-primary bg-opacity-10 d-inline-block p-4 rounded-circle mb-3 shadow-sm"><i class="fas fa-layer-group fa-3x text-primary"></i></div>
            <h2 class="fw-bold text-dark">NEXUS CLOUD</h2>
            <p class="text-muted">Gest√£o Inteligente v30.0</p>
        </div>
        <div id="login-form-area">
            <input type="email" id="email-login" class="form-control form-control-lg mb-3 bg-white border-0 shadow-sm" placeholder="Seu E-mail">
            <input type="password" id="senha-login" class="form-control form-control-lg mb-4 bg-white border-0 shadow-sm" placeholder="Sua Senha">
            <div class="d-grid gap-2">
                <button onclick="tentarLogin(this)" class="btn btn-primary btn-lg fw-bold rounded-pill shadow-lg">ACESSAR SISTEMA</button>
                <button onclick="tentarCriarConta(this)" class="btn btn-outline-dark btn-lg fw-bold rounded-pill">CRIAR NOVA CONTA</button>
                <hr class="my-3">
                <button onclick="entrarModoDemo(this)" class="btn btn-warning btn-lg fw-bold rounded-pill text-white shadow-sm"><i class="fas fa-flask me-2"></i>MODO DEMO (TESTE)</button>
            </div>
            <small class="text-muted mt-4 d-block" id="status-login"></small>
        </div>
    </div>
</div>

<div class="guest-banner">
    <i class="fas fa-eye me-2"></i> MODO VISITANTE (Somente Leitura)
</div>

<div id="area-impressao" class="hide"></div>

<div class="overlay" id="overlay" onclick="toggleMenu()"></div>
<div class="mobile-header shadow-sm">
    <div class="fw-bold fs-4"><i class="fas fa-layer-group me-2"></i>NEXUS</div>
    <button class="btn btn-outline-light border-0" onclick="toggleMenu()"><i class="fas fa-bars fa-2x"></i></button>
</div>

<nav class="sidebar" id="sidebar">
    <div class="text-center py-4 text-uppercase fw-bold fs-4">
        <i class="fas fa-cloud me-2"></i> NEXUS <span class="badge bg-white text-primary rounded-pill small" style="font-size: 0.4em; vertical-align: top;">AI</span>
    </div>
    <div class="px-3 mb-2 text-center"><small class="text-white-50" id="user-display">...</small></div>
    <div class="sidebar-menu">
        <ul class="nav flex-column gap-1 px-2">
            <li class="nav-item"><a class="nav-link active" onclick="navTo('dashboard')"><i class="fas fa-home"></i> Vis√£o Geral</a></li>
            <li class="nav-item"><a class="nav-link" onclick="navTo('ia-agent')"><i class="fas fa-robot"></i> Agente & Comandos <span class="badge bg-success ms-auto" style="font-size: 0.6em;">ON</span></a></li>
            <li class="nav-item"><a class="nav-link" onclick="navTo('pdv')"><i class="fas fa-shopping-cart"></i> PDV (Vendas)</a></li>
            <li class="nav-item"><a class="nav-link" onclick="navTo('fiados')"><i class="fas fa-address-book"></i> Fiados & Clientes <span class="badge bg-danger ms-auto" style="font-size: 0.6em;" id="badge-fiados">0</span></a></li>
            <li class="nav-item"><a class="nav-link" onclick="navTo('contas')"><i class="fas fa-file-invoice-dollar"></i> Contas a Pagar</a></li>
            <li class="nav-item"><a class="nav-link" onclick="navTo('estoque')"><i class="fas fa-box-open"></i> Estoque</a></li>
            <li class="nav-item"><a class="nav-link" onclick="navTo('financeiro')"><i class="fas fa-wallet"></i> Financeiro</a></li>
            <li class="nav-item"><a class="nav-link" onclick="navTo('relatorios')"><i class="fas fa-chart-line"></i> Relat√≥rios</a></li>
            <li class="nav-item"><a class="nav-link" onclick="navTo('os')"><i class="fas fa-tools"></i> Servi√ßos (OS)</a></li>
            <li class="nav-item"><a class="nav-link" onclick="navTo('config')"><i class="fas fa-cog"></i> Configura√ß√µes</a></li>
        </ul>
    </div>
    <div class="sidebar-footer">
        <ul class="nav flex-column gap-1 px-2">
            <li class="nav-item"><a class="nav-link text-warning" href="https://amei.sebrae.com.br/auth" target="_blank"><i class="fas fa-file-invoice"></i> Emissor Sebrae</a></li>
            <li class="nav-item"><a class="nav-link text-danger-emphasis" onclick="fazerLogout()"><i class="fas fa-sign-out-alt"></i> Sair</a></li>
        </ul>
    </div>
</nav>

<main>
    <div class="container-fluid" id="app-content" style="filter: blur(5px);">
        <div id="dashboard" class="section fade-in">
            <h3 class="fw-bold text-dark mb-4">Vis√£o Geral</h3>
            <div class="row g-3 mb-4">
                <div class="col-6 col-md-3"><div class="card card-custom card-active p-3 h-100" onclick="navTo('financeiro')"><div class="d-flex justify-content-between align-items-start mb-2"><div class="icon-box bg-green-soft"><i class="fas fa-arrow-up"></i></div><small class="text-success fw-bold">+ M√™s</small></div><h6 class="text-muted mb-1 small">Receita</h6><h4 class="fw-bold mb-0" id="dash-entradas">R$ 0,00</h4></div></div>
                <div class="col-6 col-md-3"><div class="card card-custom card-active p-3 h-100" onclick="navTo('financeiro')"><div class="d-flex justify-content-between align-items-start mb-2"><div class="icon-box bg-red-soft"><i class="fas fa-arrow-down"></i></div><small class="text-danger fw-bold">- M√™s</small></div><h6 class="text-muted mb-1 small">Despesas</h6><h4 class="fw-bold mb-0" id="dash-saidas">R$ 0,00</h4></div></div>
                <div class="col-6 col-md-3"><div class="card card-custom card-active p-3 h-100"><div class="d-flex justify-content-between align-items-start mb-2"><div class="icon-box bg-blue-soft"><i class="fas fa-wallet"></i></div></div><h6 class="text-muted mb-1 small">Saldo Atual</h6><h4 class="fw-bold mb-0 text-primary" id="dash-saldo">R$ 0,00</h4></div></div>
                <div class="col-6 col-md-3"><div class="card card-custom card-active p-3 h-100" onclick="navTo('fiados')"><div class="d-flex justify-content-between align-items-start mb-2"><div class="icon-box bg-orange-soft"><i class="fas fa-hand-holding-usd"></i></div><small class="text-danger fw-bold">A Receber</small></div><h6 class="text-muted mb-1 small">Total em Fiado</h6><h4 class="fw-bold mb-0 text-danger" id="dash-total-fiado">R$ 0,00</h4></div></div>
            </div>
            <div class="row g-4">
                <div class="col-md-4"><div class="card card-custom p-4 h-100"><h6 class="fw-bold mb-3 text-warning"><i class="fas fa-bell me-2"></i>Alertas & Avisos</h6><ul class="list-group list-group-flush small scroll-box" id="lista-alertas"><li class="list-group-item text-muted text-center py-4">Tudo certo por aqui!</li></ul></div></div>
                <div class="col-md-8"><div class="card card-custom p-4 h-100"><h6 class="fw-bold mb-3">Movimenta√ß√µes Recentes</h6><div class="table-responsive"><table class="table table-sm table-hover align-middle"><tbody id="dash-ultimas-movimentacoes"></tbody></table></div></div></div>
            </div>
        </div>

        <div id="ia-agent" class="section hide">
            <div class="row h-100">
                <div class="col-lg-8 mx-auto">
                    <div class="card card-custom h-100 p-0">
                        <div class="card-header bg-white p-3 border-bottom d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center"><div class="bg-primary text-white rounded-circle p-2 me-2"><i class="fas fa-robot"></i></div><div><h6 class="fw-bold m-0">Nexus Brain</h6><small class="text-muted">Chat de Automa√ß√£o</small></div></div>
                            <div class="dropdown"><button class="btn btn-sm btn-light rounded-pill dropdown-toggle" type="button" data-bs-toggle="dropdown">Modo</button><ul class="dropdown-menu"><li><a class="dropdown-item" href="#" onclick="setIAMode('comando')">üöÄ Executar Comandos</a></li><li><a class="dropdown-item" href="#" onclick="setIAMode('admin')">üìä Consultar Dados</a></li><li><a class="dropdown-item" href="#" onclick="setIAMode('cliente')">üí¨ Simulador de Atendimento</a></li></ul></div>
                        </div>
                        <div class="card-body bg-light"><div id="chat-output" class="chat-container"></div></div>
                        <div class="card-footer bg-white p-3"><div class="d-flex gap-2"><button class="btn btn-light border mic-btn shadow-sm" id="btn-mic" onclick="toggleMic()"><i class="fas fa-microphone"></i></button><div class="input-group"><input type="text" id="chat-input" class="form-control border-0 bg-light" placeholder="Digite ou fale..." onkeypress="if(event.key==='Enter') enviarMsgIA()"><button class="btn btn-primary" onclick="enviarMsgIA()"><i class="fas fa-paper-plane"></i></button></div></div><div id="ia-whatsapp-actions" class="mt-2 text-end hide"></div></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="pdv" class="section hide">
            <div class="row g-0">
                <div class="col-md-8 pe-md-3 mb-4">
                    <div class="d-flex justify-content-between mb-3"><h3 class="fw-bold">PDV</h3><input type="text" id="pdv-search" class="form-control w-50 rounded-pill bg-white border-0 shadow-sm" placeholder="üîç Buscar produto..." onkeyup="renderPDVGrid()"></div>
                    <div class="row g-3" id="pdv-grid"></div>
                </div>
                <div class="col-md-4">
                    <div class="cart-area p-4">
                        <div class="d-flex justify-content-between align-items-center mb-3"><h5 class="fw-bold m-0">Carrinho</h5><button class="btn btn-sm btn-light text-danger rounded-circle admin-only" onclick="limparCarrinho()"><i class="fas fa-trash"></i></button></div>
                        <div class="cart-items" id="pdv-cart-items"></div>
                        <div class="mt-auto pt-3 border-top">
                            <div class="mb-3">
                                <label class="small fw-bold text-muted mb-1">Desconto</label>
                                <div class="input-group">
                                    <span class="input-group-text p-0 border-0 overflow-hidden rounded-start">
                                        <button class="btn btn-light border-end toggle-desc active" id="btn-desc-money" onclick="toggleDescTipo('money')">R$</button>
                                        <button class="btn btn-light toggle-desc" id="btn-desc-percent" onclick="toggleDescTipo('percent')">%</button>
                                    </span>
                                    <input type="number" id="pdv-desconto" class="form-control" value="0" min="0" oninput="renderCart()">
                                </div>
                            </div>
                            <div class="d-flex justify-content-between h3 fw-bold mb-3"><span>Total</span><span id="pdv-total" class="text-primary">R$ 0,00</span></div>
                            <button class="btn btn-primary w-100 btn-lg rounded-pill fw-bold shadow-sm admin-only" onclick="abrirModalPagamento()">FINALIZAR VENDA</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="fiados" class="section hide">
            <div class="d-flex justify-content-between mb-4">
                <h3 class="fw-bold text-dark">Gest√£o de Fiados & Clientes</h3>
                <div class="d-flex gap-2">
                    <input type="text" id="busca-cliente" class="form-control rounded-pill" placeholder="üîç Buscar cliente..." onkeyup="renderFiados()">
                    <button class="btn btn-primary rounded-pill fw-bold shadow-sm text-nowrap admin-only" onclick="abrirModalNovoFiado()"><i class="fas fa-plus me-2"></i>Novo</button>
                </div>
            </div>
            <div class="card card-custom p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light text-muted small text-uppercase">
                            <tr><th class="ps-4">Cliente</th><th>WhatsApp</th><th>Status D√≠vida</th><th>Cr√©dito</th><th class="text-end pe-4">A√ß√µes</th></tr>
                        </thead>
                        <tbody id="lista-fiados"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="contas" class="section hide"><div class="d-flex justify-content-between mb-4"><h3 class="fw-bold">Contas a Pagar</h3><div class="d-flex gap-2 admin-only"><button class="btn btn-outline-primary rounded-pill fw-bold shadow-sm" onclick="abrirModalOCR('contas')"><i class="fas fa-magic me-2"></i>Ler Boleto</button><button class="btn btn-primary rounded-pill fw-bold shadow-sm" onclick="abrirModalConta()"><i class="fas fa-plus"></i> Manual</button></div></div><div class="card card-custom p-0"><div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead class="bg-light text-muted small text-uppercase"><tr><th class="ps-4">Vencimento</th><th>Descri√ß√£o/Fornecedor</th><th>Valor</th><th>Status</th><th class="text-end pe-4">A√ß√µes</th></tr></thead><tbody id="lista-contas"></tbody></table></div></div></div>

        <div id="relatorios" class="section hide">
            <h3 class="fw-bold text-dark mb-4">Relat√≥rios Gerenciais</h3>
            <div class="row g-3 mb-4">
                <div class="col-md-3"><div class="card card-custom p-3 text-white bg-success"><h6 class="opacity-75">Receita Total</h6><h3 class="fw-bold" id="rel-receita">R$ 0,00</h3></div></div>
                <div class="col-md-3"><div class="card card-custom p-3 text-white bg-danger"><h6 class="opacity-75">Despesas</h6><h3 class="fw-bold" id="rel-despesa">R$ 0,00</h3></div></div>
                <div class="col-md-3"><div class="card card-custom p-3 text-white bg-primary"><h6 class="opacity-75">Lucro L√≠quido</h6><h3 class="fw-bold" id="rel-lucro">R$ 0,00</h3></div></div>
                <div class="col-md-3"><div class="card card-custom p-3 text-white" style="background: #7c3aed;"><h6 class="opacity-75">Margem</h6><h3 class="fw-bold" id="rel-margem">0%</h3></div></div>
            </div>
            <div class="row g-4 mb-4">
                <div class="col-md-8">
                    <div class="card card-custom p-4">
                        <h6 class="fw-bold mb-4">Fluxo de Caixa</h6>
                        <div style="height: 250px;"><canvas id="graficoFinanceiro"></canvas></div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card card-custom p-4 h-100">
                        <h6 class="fw-bold mb-3">M√©todos de Pagamento</h6>
                        <div style="height: 250px;"><canvas id="graficoMetodos"></canvas></div>
                    </div>
                </div>
            </div>
            <div class="card card-custom p-4">
                <div class="d-flex justify-content-between align-items-center mb-3"><h6 class="fw-bold m-0">Extrato Detalhado</h6><button class="btn btn-sm btn-outline-secondary" onclick="imprimirExtrato()"><i class="fas fa-print me-2"></i>Imprimir</button></div>
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;"><table class="table table-hover align-middle mb-0" id="tabela-extrato"><thead class="bg-light small text-uppercase text-muted"><tr><th>Data</th><th>Descri√ß√£o</th><th>Tipo</th><th class="text-end">Valor</th></tr></thead><tbody id="rel-detalhes"></tbody></table></div>
            </div>
        </div>

        <div id="estoque" class="section hide"><div class="d-flex justify-content-between mb-4"><h3 class="fw-bold">Estoque</h3><div class="d-flex gap-2"><input type="text" id="busca-estoque" class="form-control rounded-pill" placeholder="üîç Buscar..." onkeyup="renderEstoque()"><button class="btn btn-outline-success rounded-pill" onclick="exportarDados('produtos')"><i class="fas fa-file-excel"></i></button><button class="btn btn-primary rounded-pill fw-bold shadow-sm admin-only" onclick="abrirModalProduto()"><i class="fas fa-plus"></i> Novo</button></div></div><div class="card card-custom p-0"><div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead class="bg-light text-muted small text-uppercase"><tr><th class="ps-4">Produto</th><th>Qtd</th><th>Custo</th><th>Venda</th><th>Margem</th><th class="text-end pe-4">A√ß√µes</th></tr></thead><tbody id="lista-estoque"></tbody></table></div></div></div>
        <div id="financeiro" class="section hide"><div class="d-flex justify-content-between mb-4"><h3 class="fw-bold">Financeiro</h3><div class="d-flex gap-2"><input type="text" id="busca-financa" class="form-control rounded-pill" placeholder="üîç Buscar..." onkeyup="renderFinancas()"><button class="btn btn-outline-success rounded-pill" onclick="exportarDados('financas')"><i class="fas fa-file-excel"></i></button><button class="btn btn-primary rounded-pill fw-bold shadow-sm admin-only" onclick="abrirModalFinanca()"><i class="fas fa-plus"></i> Lan√ßar</button></div></div><div class="card card-custom p-0"><div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead class="bg-light text-muted small text-uppercase"><tr><th class="ps-4">Tipo</th><th>Desc</th><th>Valor</th><th>Data</th><th class="text-end pe-4">A√ß√µes</th></tr></thead><tbody id="lista-financa"></tbody></table></div></div></div>
        
        <div id="os" class="section hide">
            <div class="d-flex justify-content-between mb-4">
                <h3 class="fw-bold">Ordens de Servi√ßo</h3>
                <button class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm admin-only" onclick="abrirModalOS()"><i class="fas fa-plus me-2"></i> Nova O.S.</button>
            </div>
            <div class="card card-custom p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light text-muted small text-uppercase">
                            <tr>
                                <th class="ps-4">Cliente</th>
                                <th>Descri√ß√£o/Defeito</th>
                                <th>Prazo</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th class="text-end pe-4">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="lista-os"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="config" class="section hide">
            <h3 class="fw-bold text-dark mb-4">Configura√ß√µes</h3>
            <div class="row justify-content-center"><div class="col-md-8"><div class="card card-custom p-5">
                <h5 class="fw-bold mb-3 border-bottom pb-2">Compartilhamento (Modo Visitante)</h5>
                <div class="alert alert-info small">Gerar um link seguro para que outras pessoas vejam os dados SEM poder alterar, deletar ou resetar.</div>
                <div class="input-group mb-3">
                    <input type="text" id="link-visitante" class="form-control bg-light" readonly>
                    <button class="btn btn-outline-primary" onclick="copiarLinkVisitante()">Copiar</button>
                    <button class="btn btn-primary" onclick="gerarLinkVisitante()">Gerar Link</button>
                </div>

                <h5 class="fw-bold mb-3 border-bottom pb-2 mt-4 admin-only">Dados da Loja</h5>
                <div class="mb-3 admin-only"><label>Nome</label><input type="text" id="conf-nome" class="form-control bg-light border-0"></div>
                <div class="mb-3 admin-only"><label>CNPJ</label><input type="text" id="conf-cnpj" class="form-control bg-light border-0"></div>
                <div class="mb-3 admin-only"><label>Endere√ßo</label><input type="text" id="conf-end" class="form-control bg-light border-0"></div>
                <div class="mb-3 admin-only"><label>Rodap√© Cupom</label><input type="text" id="conf-msg" class="form-control bg-light border-0"></div>
                
                <h5 class="fw-bold mb-3 border-bottom pb-2 mt-4 admin-only">Chave IA (Opcional)</h5>
                <div class="mb-3 admin-only"><label>API Key</label><input type="password" id="conf-apikey" class="form-control bg-light border-0" placeholder="AIza..."></div>
                <button class="btn btn-success w-100 btn-lg rounded-pill fw-bold mt-3 admin-only" onclick="salvarConfig(this)">SALVAR DADOS</button>
                <hr class="my-4 admin-only"><h5 class="text-danger fw-bold mb-3 admin-only">Zona de Perigo</h5>
                <button class="btn btn-outline-danger w-100 rounded-pill fw-bold admin-only" onclick="resetarSistema()"><i class="fas fa-trash-alt me-2"></i> RESETAR SISTEMA (Apagar Tudo)</button>
            </div></div></div>
        </div>
    </div>
</main>

<div class="modal fade" id="modalPagamento" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 rounded-4"><div class="modal-header border-0 pb-0"><h5 class="fw-bold">Finalizar Venda</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-4"><div class="text-center mb-3"><small class="text-muted text-uppercase">Total a Pagar</small><h1 class="fw-bold display-4 text-primary" id="modal-pag-total">R$ 0,00</h1></div><div class="mb-3"><input type="text" id="cliente-pdv" class="form-control bg-light border-0 text-center" placeholder="Nome do Cliente (Busca Cr√©ditos)" onblur="verificarCreditoCliente()"><div id="aviso-credito" class="text-center mt-2 small text-success fw-bold hide"></div><input type="text" id="cliente-zap" class="form-control bg-light border-0 text-center mt-2" placeholder="WhatsApp (Apenas n√∫meros) para recibo"></div><p class="fw-bold mb-3 text-muted small">SELECIONE O M√âTODO:</p><input type="hidden" id="pag-metodo" value=""><div class="row g-3 mb-4"><div class="col-4"><div class="btn-pagamento" onclick="selectPagamento('Dinheiro', this)"><i class="fas fa-money-bill-wave text-success"></i><span class="fw-bold small">Dinheiro</span></div></div><div class="col-4"><div class="btn-pagamento" onclick="selectPagamento('PIX', this)"><i class="fas fa-qrcode text-info"></i><span class="fw-bold small">PIX</span></div></div><div class="col-4"><div class="btn-pagamento" onclick="selectPagamento('Cart√£o', this)"><i class="fas fa-credit-card text-primary"></i><span class="fw-bold small">Cart√£o</span></div></div><div class="col-12"><div class="btn-pagamento border-danger" onclick="selectPagamento('Fiado', this)"><i class="fas fa-hand-holding-usd text-danger"></i><span class="fw-bold small">Fiado / Pendente</span></div></div></div><button class="btn btn-success w-100 btn-lg rounded-pill fw-bold shadow py-3" onclick="processarVenda(this)"><i class="fas fa-check me-2"></i> CONFIRMAR</button></div></div></div></div>
<div class="modal fade" id="modalPagarFiado" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 rounded-4"><div class="modal-body p-4"><h5 class="fw-bold mb-3">Receber D√≠vida</h5><input type="hidden" id="fiado-id"><h3 class="text-center text-danger fw-bold mb-3" id="fiado-valor-total">R$ 0,00</h3><label>Valor a Receber Agora (R$)</label><input type="number" id="fiado-valor-pagar" class="form-control form-control-lg mb-3"><button class="btn btn-success w-100 rounded-pill fw-bold" onclick="confirmarRecebimentoFiado(this)">RECEBER VALOR</button></div></div></div></div>
<div class="modal fade" id="modalNovoFiado" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 rounded-4"><div class="modal-body p-4"><h5 class="fw-bold mb-3">Novo Cliente / Fiado</h5><div class="alert alert-info small">Se o nome j√° existir, o saldo ser√° unificado.</div><div class="mb-3"><label>Nome do Cliente</label><input type="text" id="novo-fiado-nome" class="form-control bg-light border-0"></div><div class="mb-3"><label>WhatsApp</label><input type="text" id="novo-fiado-zap" class="form-control bg-light border-0"></div><div class="mb-3"><label>Valor Inicial da D√≠vida (Opcional)</label><input type="number" id="novo-fiado-valor" class="form-control bg-light border-0" value="0"></div><button class="btn btn-primary w-100 rounded-pill fw-bold" onclick="criarNovoFiado(this)">SALVAR CLIENTE</button></div></div></div></div>

<div class="modal fade" id="modalEditarFiado" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 rounded-4"><div class="modal-body p-4"><h5 class="fw-bold mb-3">Editar Cliente</h5><input type="hidden" id="edit-fiado-id"><div class="mb-3"><label>Nome do Cliente</label><input type="text" id="edit-fiado-nome" class="form-control bg-light border-0"></div><div class="mb-3"><label>WhatsApp</label><input type="text" id="edit-fiado-zap" class="form-control bg-light border-0"></div><button class="btn btn-success w-100 rounded-pill fw-bold" onclick="salvarEdicaoFiado(this)">ATUALIZAR DADOS</button></div></div></div></div>

<div class="modal fade" id="modalOCR" tabindex="-1"><div class="modal-dialog"><div class="modal-content border-0 rounded-4"><div class="modal-body p-4 text-center"><input type="hidden" id="ocr-origem" value="contas"><h5 class="fw-bold mb-3">Scanner Inteligente</h5><div class="border dashed p-4 mb-3 rounded bg-light"><i class="fas fa-camera fa-2x text-muted mb-2"></i><input type="file" id="ocr-file" class="form-control" accept="image/*" onchange="processarImagemOCR(this)"></div><div id="ocr-progress" class="hide mb-3"><div class="progress"><div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%">Analisando Imagem...</div></div></div><div id="ocr-result" class="hide text-start"><div class="alert alert-success small"><i class="fas fa-check-circle"></i> Leitura conclu√≠da! Tentei preencher o formul√°rio para voc√™.</div></div></div></div></div></div>
<div class="modal fade" id="modalConta" tabindex="-1"><div class="modal-dialog"><div class="modal-content border-0 rounded-4"><div class="modal-body p-4"><h5 class="fw-bold mb-3">Conta a Pagar</h5><input type="text" id="conta-desc" class="form-control mb-2 bg-light border-0" placeholder="Descri√ß√£o"><div class="row g-2"><div class="col-6"><input type="number" id="conta-valor" class="form-control bg-light border-0" placeholder="R$"></div><div class="col-6"><input type="text" id="conta-venc" class="form-control bg-light border-0" placeholder="DD/MM/AAAA (ou YYYY-MM-DD)"></div></div><div class="form-check mt-3"><input class="form-check-input" type="checkbox" id="conta-recorrente"><label class="form-check-label" for="conta-recorrente">Custo Fixo Mensal (Ex: Aluguel)</label></div><button class="btn btn-primary w-100 mt-4 rounded-pill fw-bold" onclick="salvarConta(this)">SALVAR CONTA</button></div></div></div></div>

<div class="modal fade" id="modalEditarConta" tabindex="-1"><div class="modal-dialog"><div class="modal-content border-0 rounded-4"><div class="modal-body p-4"><h5 class="fw-bold mb-3">Editar Conta</h5><input type="hidden" id="edit-conta-id"><div class="mb-3"><label>Descri√ß√£o</label><input type="text" id="edit-conta-desc" class="form-control bg-light border-0"></div><div class="row g-2 mb-3"><div class="col-6"><label>Valor</label><input type="number" id="edit-conta-valor" class="form-control bg-light border-0"></div><div class="col-6"><label>Vencimento</label><input type="text" id="edit-conta-venc" class="form-control bg-light border-0"></div></div><button class="btn btn-success w-100 rounded-pill fw-bold" onclick="salvarEdicaoConta(this)">ATUALIZAR CONTA</button></div></div></div></div>

<div class="modal fade" id="modalProduto" tabindex="-1"><div class="modal-dialog"><div class="modal-content border-0 rounded-4"><div class="modal-body p-4"><input type="hidden" id="prod-id"><h5 class="fw-bold mb-3" id="modal-prod-titulo">Novo Produto</h5><input type="text" id="prod-nome" class="form-control mb-3 bg-light border-0" placeholder="Nome"><div class="row g-2"><div class="col-6"><input type="number" id="prod-qtd" class="form-control bg-light border-0" placeholder="Qtd"></div><div class="col-6"><input type="number" id="prod-min" class="form-control bg-light border-0" placeholder="Min" value="5"></div><div class="col-6"><input type="number" id="prod-custo" class="form-control bg-light border-0" placeholder="Custo"></div><div class="col-6"><input type="number" id="prod-venda" class="form-control bg-light border-0" placeholder="Venda"></div></div><button class="btn btn-primary w-100 mt-4 rounded-pill fw-bold" onclick="salvarProduto(this)">SALVAR</button></div></div></div></div>
<div class="modal fade" id="modalFinanca" tabindex="-1"><div class="modal-dialog modal-sm"><div class="modal-content border-0 rounded-4"><div class="modal-body p-4"><h5 class="fw-bold mb-3">Lan√ßamento</h5><input type="text" id="fin-desc" class="form-control mb-2 bg-light border-0" placeholder="Descri√ß√£o"><select id="fin-tipo" class="form-select mb-2 bg-light border-0"><option value="entrada">Entrada</option><option value="saida">Sa√≠da</option></select><input type="number" id="fin-valor" class="form-control mb-3 bg-light border-0" placeholder="Valor"><button class="btn btn-success w-100 rounded-pill fw-bold" onclick="salvarFinanca(this)">SALVAR</button></div></div></div></div>
<div class="modal fade" id="modalOS" tabindex="-1"><div class="modal-dialog"><div class="modal-content border-0 rounded-4"><div class="modal-body p-4"><h5 class="fw-bold mb-3">Nova O.S.</h5><input type="text" id="os-cliente" class="form-control mb-2 bg-light border-0" placeholder="Nome do Cliente"><textarea id="os-desc" class="form-control mb-2 bg-light border-0" placeholder="Descri√ß√£o do Servi√ßo / Defeito" rows="3"></textarea><div class="row g-2"><div class="col-6"><input type="number" id="os-valor" class="form-control bg-light border-0" placeholder="Valor (Deixe 0 para Or√ßamento)"></div><div class="col-6"><input type="date" id="os-data" class="form-control bg-light border-0"></div></div><button class="btn btn-primary w-100 mt-4 rounded-pill fw-bold" onclick="salvarOS(this)">CRIAR O.S.</button></div></div></div></div>
<div class="modal fade" id="modalEditarOS" tabindex="-1"><div class="modal-dialog"><div class="modal-content border-0 rounded-4"><div class="modal-body p-4"><h5 class="fw-bold mb-3">Editar O.S.</h5><input type="hidden" id="edit-os-id"><input type="text" id="edit-os-cliente" class="form-control mb-2 bg-light border-0" readonly><textarea id="edit-os-desc" class="form-control mb-2 bg-light border-0" rows="3"></textarea><div class="row g-2"><div class="col-6"><input type="number" id="edit-os-valor" class="form-control bg-light border-0" placeholder="Novo Valor"></div><div class="col-6"><input type="date" id="edit-os-data" class="form-control bg-light border-0"></div></div><button class="btn btn-success w-100 mt-4 rounded-pill fw-bold" onclick="salvarEdicaoOS(this)">ATUALIZAR</button></div></div></div></div>
<div class="modal fade" id="modalCredito" tabindex="-1"><div class="modal-dialog modal-sm modal-dialog-centered"><div class="modal-content border-0 rounded-4"><div class="modal-body p-4 text-center"><h5 class="fw-bold mb-1" id="cred-cliente-nome">...</h5><p class="text-muted small">Gerenciar Cr√©dito</p><h2 class="text-success fw-bold mb-3" id="cred-atual">R$ 0,00</h2><input type="hidden" id="cred-id"><label class="small text-start w-100 fw-bold text-muted">Adicionar / Remover</label><input type="number" id="cred-valor" class="form-control mb-3 text-center" placeholder="0.00"><div class="d-flex gap-2"><button class="btn btn-success flex-fill rounded-pill" onclick="atualizarCredito(1)"><i class="fas fa-plus"></i> Add</button><button class="btn btn-danger flex-fill rounded-pill" onclick="atualizarCredito(-1)"><i class="fas fa-minus"></i> Remover</button></div></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

<script>
    const firebaseConfig = { apiKey: "AIzaSyBHBFj0QRebascuwJ5LxprYeuFbk7KsiYc", authDomain: "nexus-erp-6998c.firebaseapp.com", projectId: "nexus-erp-6998c", storageBucket: "nexus-erp-6998c.firebasestorage.app", messagingSenderId: "599369243365", appId: "1:599369243365:web:3363fe65f3d36c00e1d20c", measurementId: "G-7NFRRWYYJ6" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    
    db.enablePersistence({ synchronizeTabs: true }).catch(err => console.warn('Persist√™ncia desativada:', err.code));
    const esc = (unsafe) => { if (!unsafe) return ''; return unsafe.replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); };
    const norm = (str) => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

    // VARI√ÅVEIS GLOBAIS
    let currentUser = null;
    let isDemoMode = false;
    let isGuestMode = false; // FLAG DE VISITANTE
    let produtos=[], financas=[], osList=[], historico=[], carrinho=[], fiados=[], contas=[];
    let configEmpresa = { nome: 'NEXUS ERP', cnpj: '', end: '', tel: '', msg: 'Volte Sempre!', apikey: '' };
    let iaMode = 'comando', iaContext = null;
    let recognition;
    let descTipo = 'money';
    let chartFin = null, chartMet = null;

    // SIMULADOR DE BANCO DE DADOS (MOCK) PARA MODO DEMO
    const MockDB = {
        collection: (col) => ({
            doc: (id) => {
                const docId = id || 'demo_'+Date.now();
                return {
                    id: docId,
                    set: async (data) => { if(col==='financas') financas.unshift({...data, id:docId}); if(col==='historico') historico.unshift({...data, id:docId}); if(col==='os') osList.push({...data, id:docId}); atualizarDashboard(); },
                    update: async (data) => { 
                        if(col==='os') { const idx = osList.findIndex(x=>x.id===id); if(idx>=0) osList[idx] = {...osList[idx], ...data}; }
                        if(col==='produtos') { const idx = produtos.findIndex(x=>x.id===id); if(idx>=0) produtos[idx] = {...produtos[idx], ...data}; }
                        if(col==='fiados') { const idx = fiados.findIndex(x=>x.id===id); if(idx>=0) fiados[idx] = {...fiados[idx], ...data}; }
                        if(col==='contas') { const idx = contas.findIndex(x=>x.id===id); if(idx>=0) contas[idx] = {...contas[idx], ...data}; }
                        atualizarDashboard(); 
                    },
                    delete: async () => { 
                        if(col==='os') osList = osList.filter(x=>x.id!==id);
                        if(col==='financas') financas = financas.filter(x=>x.id!==id);
                        if(col==='produtos') produtos = produtos.filter(x=>x.id!==id);
                        if(col==='contas') contas = contas.filter(x=>x.id!==id);
                        if(col==='fiados') fiados = fiados.filter(x=>x.id!==id);
                        atualizarDashboard(); renderOS(); renderFinancas(); renderEstoque(); renderContas(); renderFiados();
                    },
                    get: async () => ({ data: () => {
                         if(col==='fiados') return fiados.find(f=>f.id===id);
                         return {};
                    } })
                }
            },
            add: async (data) => { 
                const newId = 'demo_'+Date.now(); 
                if(col==='historico') historico.unshift({...data, id:newId});
                if(col==='financas') financas.unshift({...data, id:newId});
                if(col==='os') { osList.push({...data, id:newId}); renderOS(); }
                if(col==='contas') { contas.push({...data, id:newId}); renderContas(); }
                if(col==='produtos') { produtos.push({...data, id:newId}); renderEstoque(); }
                if(col==='fiados') { fiados.push({...data, id:newId}); renderFiados(); }
                atualizarDashboard();
                return { id: newId };
            },
            orderBy: () => ({ limit: () => ({ onSnapshot: () => {} }) }),
            onSnapshot: () => {} 
        })
    };

    function getUserRef(c) { 
        if (isDemoMode) return MockDB.collection(c);
        if (isGuestMode) return null; // Visitante apenas le, nao grava por aqui
        return currentUser ? db.collection("users").doc(currentUser.uid).collection(c) : null; 
    }
    
    function getConfigRef() { 
        if (isDemoMode) return { set: async (d) => { configEmpresa = d; }, onSnapshot: (cb) => cb({exists:true, data:()=>configEmpresa}) };
        return currentUser ? db.collection("users").doc(currentUser.uid).collection("config").doc("geral") : null; 
    }

    function setLoading(btn, isLoading) { if(isLoading) { btn.disabled=true; btn.orig=btn.innerHTML; btn.innerHTML='<span class="spinner-border spinner-border-sm"></span>'; } else { btn.disabled=false; btn.innerHTML=btn.orig; } }

    function tentarLogin(btn) { setLoading(btn,true); auth.signInWithEmailAndPassword(document.getElementById('email-login').value, document.getElementById('senha-login').value).catch(e=>{Swal.fire('Erro',e.message,'error'); setLoading(btn,false)}); }
    function tentarCriarConta(btn) { setLoading(btn,true); auth.createUserWithEmailAndPassword(document.getElementById('email-login').value, document.getElementById('senha-login').value).then(()=>{Swal.fire('Sucesso','','success')}).catch(e=>{Swal.fire('Erro',e.message,'error'); setLoading(btn,false)}); }
    function fazerLogout() { auth.signOut(); location.reload(); }

    function entrarModoDemo(btn) {
        setLoading(btn, true);
        setTimeout(() => {
            isDemoMode = true;
            currentUser = { uid: 'demo_user', email: 'demo@nexus.ai' };
            document.getElementById('login-screen').classList.add('hide');
            document.getElementById('app-content').style.filter='none';
            document.getElementById('user-display').innerText = "MODO DEMO";
            
            // Dados Fict√≠cios
            produtos = [{id:'1', nome:'Coca Cola 2L', qtd:50, custo:6.00, venda:10.00, min:10}, {id:'2', nome:'Cabo USB-C', qtd:20, custo:5.00, venda:25.00, min:5}];
            fiados = [{id:'1', cliente:'Jo√£o Silva', zap:'11999999999', valorRestante:50.00, saldoCredito:0}];
            osList = [{id:'1', cliente:'Pedro Ramos', desc:'Formatar PC', valor:80.00, prazo:'2026-02-10', concluido:false, dataCriacao: new Date().toISOString()}];
            financas = [{id:'1', tipo:'entrada', desc:'Venda Balc√£o', valor:150.00, dataISO: new Date().toISOString()}];
            contas = [{id:'1', desc:'Energia', valor:200.00, venc:'2026-02-15', recorrente:true}];

            renderEstoque(); renderPDVGrid(); renderFiados(); renderOS(); renderFinancas(); renderContas(); atualizarDashboard(); renderRelatorios();
            setIAMode('comando');
            Swal.fire('Modo Demo Ativado', 'Os dados salvos aqui n√£o persistem.', 'info');
        }, 1000);
    }

    // --- L√ìGICA DE VISITANTE ---
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const guestUid = urlParams.get('mode') === 'guest' ? urlParams.get('uid') : null;

        if (guestUid) {
            // Entrar como visitante
            isGuestMode = true;
            isDemoMode = false; // Usa banco real mas s√≥ leitura
            currentUser = { uid: guestUid, email: 'Visitante' };
            document.getElementById('login-screen').classList.add('hide');
            document.getElementById('app-content').style.filter='none';
            document.getElementById('user-display').innerText = "MODO VISITANTE";
            document.body.classList.add('guest-mode'); // Esconde botoes Admin
            iniciarSistema();
        }
    };

    auth.onAuthStateChanged(u => {
        if(u && !isDemoMode && !isGuestMode) { currentUser=u; document.getElementById('login-screen').classList.add('hide'); document.getElementById('app-content').style.filter='none'; document.getElementById('user-display').innerText=u.email; iniciarSistema(); }
        else if (!isDemoMode && !isGuestMode) { document.getElementById('login-screen').classList.remove('hide'); document.getElementById('app-content').style.filter='blur(5px)'; }
    });

    function iniciarSistema() {
        if(!currentUser) return;
        
        // Se for visitante, usamos currentUser.uid que veio da URL
        const uid = currentUser.uid;

        db.collection("users").doc(uid).collection("produtos").onSnapshot(s => { produtos = s.docs.map(d=>({id:d.id, ...d.data()})); renderEstoque(); renderPDVGrid(); atualizarDashboard(); });
        db.collection("users").doc(uid).collection("financas").orderBy("dataISO","desc").limit(50).onSnapshot(s => { financas = s.docs.map(d=>({id:d.id, ...d.data()})); renderFinancas(); atualizarDashboard(); if(!document.getElementById('relatorios').classList.contains('hide')) renderRelatorios(); });
        db.collection("users").doc(uid).collection("historico").orderBy("data","desc").limit(20).onSnapshot(s => { historico = s.docs.map(d=>({id:d.id, ...d.data()})); atualizarDashboard(); });
        db.collection("users").doc(uid).collection("os").onSnapshot(s => { osList = s.docs.map(d=>({id:d.id, ...d.data()})); renderOS(); atualizarDashboard(); });
        db.collection("users").doc(uid).collection("fiados").onSnapshot(s => { fiados = s.docs.map(d=>({id:d.id, ...d.data()})); renderFiados(); atualizarDashboard(); });
        db.collection("users").doc(uid).collection("contas").onSnapshot(s => { contas = s.docs.map(d=>({id:d.id, ...d.data()})); renderContas(); atualizarDashboard(); });
        
        db.collection("users").doc(uid).collection("config").doc("geral").onSnapshot(s => { if(s.exists) { configEmpresa = s.data(); carregarConfigUI(); } });
        
        setupVoiceRecognition();
        setIAMode('comando');
    }

    // DASHBOARD & ALERTAS
    function atualizarDashboard() {
        let ent=0, sai=0;
        financas.forEach(f => { f.tipo==='entrada'? ent+=f.valor : sai+=f.valor });
        document.getElementById('dash-entradas').innerText = formatCurrency(ent);
        document.getElementById('dash-saidas').innerText = formatCurrency(sai);
        document.getElementById('dash-saldo').innerText = formatCurrency(ent-sai);
        
        let totalFiado = fiados.reduce((acc, f) => acc + (f.valorRestante || 0), 0);
        document.getElementById('dash-total-fiado').innerText = formatCurrency(totalFiado);
        document.getElementById('badge-fiados').innerText = fiados.filter(f=>f.valorRestante > 0).length;
        
        const listaAlertas = document.getElementById('lista-alertas');
        listaAlertas.innerHTML = '';
        let alertasCount = 0;

        produtos.filter(p => p.qtd <= (p.min || 5)).forEach(p => {
            listaAlertas.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center bg-warning-soft alert-item-click" onclick="navTo('estoque'); document.getElementById('busca-estoque').value = '${esc(p.nome)}'; renderEstoque();"><span class="small fw-bold"><i class="fas fa-box text-warning me-2"></i>${esc(p.nome)}</span><span class="badge bg-warning text-dark">${p.qtd} un</span></li>`;
            alertasCount++;
        });

        const hoje = new Date(); hoje.setHours(0,0,0,0);
        contas.forEach(c => {
            const vencParts = c.venc.includes('/') ? c.venc.split('/') : c.venc.split('-');
            const dataVenc = new Date(vencParts[0].length===4 ? c.venc : `${vencParts[2]}-${vencParts[1]}-${vencParts[0]}`);
            const diffDias = Math.ceil((dataVenc - hoje) / (1000 * 60 * 60 * 24));
            if(diffDias <= 3) {
                const cor = diffDias < 0 ? 'bg-danger-soft' : 'bg-orange-soft';
                const texto = diffDias < 0 ? `Venceu dia ${c.venc}` : (diffDias === 0 ? 'Vence HOJE' : `Vence dia ${c.venc}`);
                listaAlertas.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center ${cor} alert-item-click" onclick="navTo('contas')"><span class="small fw-bold"><i class="fas fa-file-invoice-dollar text-danger me-2"></i>${esc(c.desc)}</span><span class="badge bg-danger">${texto}</span></li>`;
                alertasCount++;
            }
        });

        if(alertasCount === 0) listaAlertas.innerHTML = '<li class="list-group-item text-muted text-center py-3">Tudo certo por aqui!</li>';
        
        const tb = document.getElementById('dash-ultimas-movimentacoes'); 
        tb.innerHTML = historico.slice(0,5).map(h => `<tr><td><span class="badge bg-light text-dark border">${esc(h.tipo)}</span></td><td class="small">${esc(h.desc)}</td><td class="fw-bold text-end">${formatCurrency(h.valor)}</td></tr>`).join('');
    }

    // PDV L√ìGICA
    function renderPDVGrid(){ 
        const c=document.getElementById('pdv-grid'); 
        const s=norm(document.getElementById('pdv-search').value); 
        c.innerHTML = produtos.filter(p=>norm(p.nome).includes(s)).map(p => 
            `<div class="col-6 col-lg-4"><div class="card p-3 pdv-product-card h-100" onclick="addCart('${p.id}')"><div class="d-flex justify-content-between mb-2"><span class="badge bg-light text-secondary border">Est: ${p.qtd}</span></div><div class="fw-bold mb-1 text-truncate">${esc(p.nome)}</div><div class="h5 text-primary fw-bold">${formatCurrency(p.venda)}</div></div></div>`
        ).join('');
    }
    
    function addCart(id){ const p=produtos.find(x=>x.id===id), i=carrinho.find(c=>c.id===id); if(p.qtd<=(i?i.qty:0)) return Swal.fire({toast:true,icon:'error',title:'Estoque insuficiente',timer:1000,showConfirmButton:false}); i?i.qty++:carrinho.push({...p,qty:1}); renderCart(); }
    function setCartQty(id, val) { const i=carrinho.find(c=>c.id===id), p=produtos.find(x=>x.id===id); if(!i) return; let n = parseInt(val); if(isNaN(n) || n < 1) n = 1; if(n > p.qtd) { Swal.fire({toast:true,icon:'warning',title:'M√°ximo em estoque: '+p.qtd,timer:1000,showConfirmButton:false}); n = p.qtd; } i.qty = n; renderCart(); }
    function updateCartQty(id, d) { const i=carrinho.find(c=>c.id===id); if(i) setCartQty(id, i.qty + d); }
    function toggleDescTipo(tipo) { descTipo = tipo; document.getElementById('btn-desc-money').classList.toggle('active', tipo === 'money'); document.getElementById('btn-desc-percent').classList.toggle('active', tipo === 'percent'); renderCart(); }

    function renderCart(){ 
        const c=document.getElementById('pdv-cart-items'); 
        let sub=0; 
        c.innerHTML = carrinho.map(i => {
            sub+=i.venda*i.qty;
            return `<div class="d-flex justify-content-between align-items-center mb-2 bg-light p-2 rounded"><div style="width:35%" class="text-truncate fw-bold small">${esc(i.nome)}</div><div class="d-flex align-items-center admin-only"><button class="btn btn-sm btn-white border px-2" onclick="updateCartQty('${i.id}',-1)">-</button><input type="number" class="qty-input-field" value="${i.qty}" onchange="setCartQty('${i.id}', this.value)"><button class="btn btn-sm btn-white border px-2" onclick="updateCartQty('${i.id}',1)">+</button></div><div class="fw-bold small text-end" style="width:25%">${formatCurrency(i.venda*i.qty)}</div></div>`;
        }).join('');
        
        let descVal = parseFloat(document.getElementById('pdv-desconto').value) || 0;
        let totalDesc = descTipo === 'percent' ? sub * (descVal / 100) : descVal;
        const tot = Math.max(0, sub - totalDesc); 
        document.getElementById('pdv-total').innerText=formatCurrency(tot); 
        document.getElementById('modal-pag-total').innerText=formatCurrency(tot); 
    }
    
    function limparCarrinho(){ carrinho=[]; renderCart(); }
    
    function verificarCreditoCliente() {
        const nome = norm(document.getElementById('cliente-pdv').value);
        const cli = fiados.find(f => norm(f.cliente) === nome);
        const aviso = document.getElementById('aviso-credito');
        if (cli && cli.saldoCredito > 0) {
            aviso.innerText = `Cliente possui CR√âDITO de ${formatCurrency(cli.saldoCredito)}`;
            aviso.classList.remove('hide');
        } else {
            aviso.classList.add('hide');
        }
    }

    function abrirModalPagamento(){ if(carrinho.length) new bootstrap.Modal(document.getElementById('modalPagamento')).show(); }

    // --- VENDA COM L√ìGICA DE CR√âDITO CORRIGIDA ---
    async function processarVenda(btn){
        if(isGuestMode) return; 
        const metodo = document.getElementById('pag-metodo').value; 
        if(!metodo) return Swal.fire('Erro','Selecione o m√©todo de pagamento','error');
        const clienteNome = document.getElementById('cliente-pdv').value.trim();
        const total = parseFloat(document.getElementById('pdv-total').innerText.replace('R$','').replace('.','').replace(',','.').trim());
        
        if(metodo === 'Fiado' && !clienteNome) return Swal.fire('Erro','Nome do cliente obrigat√≥rio para Fiado','error');

        setLoading(btn,true);
        const batch = isDemoMode ? MockDB : db.batch();
        const dataISO = new Date().toISOString();
        
        // 1. Baixar Estoque
        carrinho.forEach(i => { batch.update(getUserRef("produtos").doc(i.id), { qtd: firebase.firestore.FieldValue.increment(-i.qty) }); });

        let valorFinalAPagar = total;
        let usouCredito = 0;
        let clienteDoc = fiados.find(f => norm(f.cliente) === norm(clienteNome));
        let clienteRef = clienteDoc ? getUserRef("fiados").doc(clienteDoc.id) : getUserRef("fiados").doc();

        // 2. L√≥gica de Cr√©dito Inteligente (Evitar Saldo Negativo)
        // Se cliente tem cr√©dito, usa primeiro.
        if (clienteDoc && clienteDoc.saldoCredito > 0) {
            if (clienteDoc.saldoCredito >= valorFinalAPagar) {
                // Tem cr√©dito suficiente para cobrir tudo
                usouCredito = valorFinalAPagar;
                batch.update(clienteRef, { saldoCredito: clienteDoc.saldoCredito - valorFinalAPagar });
                valorFinalAPagar = 0; // Tudo pago com cr√©dito
            } else {
                // Cr√©dito abate uma parte
                usouCredito = clienteDoc.saldoCredito;
                valorFinalAPagar = valorFinalAPagar - usouCredito;
                batch.update(clienteRef, { saldoCredito: 0 }); // Zerou cr√©dito
            }
        }

        // 3. O que sobrou (valorFinalAPagar) vira D√≠vida ou Entrada Caixa
        if(valorFinalAPagar > 0) {
            if(metodo === 'Fiado') {
                if(clienteDoc) batch.update(clienteRef, { valorRestante: (clienteDoc.valorRestante || 0) + valorFinalAPagar, ultimaAtualizacao: dataISO });
                else batch.set(clienteRef, { cliente: clienteNome, zap: document.getElementById('cliente-zap').value, valorRestante: valorFinalAPagar, saldoCredito: 0, dataCompra: dataISO, ultimaAtualizacao: dataISO });
            } else {
                batch.set(getUserRef("financas").doc(), { tipo: 'entrada', desc: `Venda PDV - ${clienteNome || 'Balc√£o'}`, metodo: metodo, valor: valorFinalAPagar, dataISO: dataISO });
            }
        } else if (usouCredito > 0 && valorFinalAPagar === 0) {
             // Venda totalmente paga com cr√©dito, registrar no hist√≥rico apenas
             // N√£o gera entrada financeira pois o dinheiro entrou quando o cliente comprou o cr√©dito ou pagou antecipado
        }

        let descHist = `Venda ${metodo}`;
        if(usouCredito > 0) descHist += ` (Cr√©dito ${formatCurrency(usouCredito)})`;
        batch.set(getUserRef("historico").doc(), { tipo: 'Venda', desc: descHist, valor: total, data: dataISO });

        if(!isDemoMode) await batch.commit();
        setLoading(btn,false);
        
        bootstrap.Modal.getInstance(document.getElementById('modalPagamento')).hide();
        limparCarrinho();
        document.getElementById('cliente-pdv').value = '';
        document.getElementById('aviso-credito').classList.add('hide');
        
        Swal.fire({
            title: 'Venda Sucesso!', text: "Deseja imprimir o comprovante?", icon: 'success', showCancelButton: true, confirmButtonText: 'Sim, imprimir'
        }).then((result) => { if (result.isConfirmed) alert('Impress√£o enviada'); });
    }

    // FIADOS & CLIENTES (COM BOT√ÉO EDITAR NOVO)
    function renderFiados(){
        const t = document.getElementById('lista-fiados');
        const termo = norm(document.getElementById('busca-cliente').value);
        t.innerHTML = fiados.filter(f => !termo || norm(f.cliente).includes(termo)).map(f => {
            const temDivida = f.valorRestante > 0;
            const temCredito = f.saldoCredito > 0;
            return `<tr>
                <td class="ps-4 fw-bold">${esc(f.cliente)}</td>
                <td>${f.zap ? `<a href="#" onclick="window.open('https://wa.me/55${f.zap.replace(/\D/g,'')}')"><i class="fab fa-whatsapp text-success"></i> ${esc(f.zap)}</a>` : '-'}</td>
                <td>${temDivida ? `<span class="badge bg-danger">Deve: ${formatCurrency(f.valorRestante)}</span>` : '<span class="badge bg-success">Em dia</span>'}</td>
                <td>${temCredito ? `<span class="text-success fw-bold">${formatCurrency(f.saldoCredito)}</span>` : '-'}</td>
                <td class="text-end pe-4">
                    <button class="btn btn-sm btn-light text-primary me-1 admin-only" onclick="abrirModalEditarFiado('${f.id}')" title="Editar"><i class="fas fa-pen"></i></button>
                    <button class="btn btn-sm btn-outline-primary rounded-pill me-1 admin-only" onclick="abrirModalCredito('${f.id}', '${esc(f.cliente)}', ${f.saldoCredito || 0})" title="Gerenciar Cr√©dito"><i class="fas fa-wallet"></i></button>
                    ${temDivida ? `<button class="btn btn-sm btn-outline-danger rounded-pill me-1 admin-only" onclick="abrirModalPagarFiado('${f.id}', ${f.valorRestante})">Receber</button>` : ''}
                    <button class="btn btn-sm btn-light text-danger rounded-circle admin-only" onclick="del('fiados','${f.id}')"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        }).join('');
    }

    // FUN√á√ïES DE EDI√á√ÉO FIADO
    function abrirModalEditarFiado(id) {
        if(isGuestMode) return;
        const f = fiados.find(x => x.id === id);
        document.getElementById('edit-fiado-id').value = id;
        document.getElementById('edit-fiado-nome').value = f.cliente;
        document.getElementById('edit-fiado-zap').value = f.zap || '';
        new bootstrap.Modal(document.getElementById('modalEditarFiado')).show();
    }

    async function salvarEdicaoFiado(btn) {
        if(isGuestMode) return;
        const id = document.getElementById('edit-fiado-id').value;
        const nome = document.getElementById('edit-fiado-nome').value;
        const zap = document.getElementById('edit-fiado-zap').value;
        setLoading(btn, true);
        await getUserRef("fiados").doc(id).update({ cliente: nome, zap: zap });
        setLoading(btn, false);
        bootstrap.Modal.getInstance(document.getElementById('modalEditarFiado')).hide();
        Swal.fire('Atualizado', 'Dados do cliente salvos.', 'success');
    }

    function abrirModalCredito(id, nome, saldo) {
        if(isGuestMode) return;
        document.getElementById('cred-id').value = id;
        document.getElementById('cred-cliente-nome').innerText = nome;
        document.getElementById('cred-atual').innerText = formatCurrency(saldo);
        document.getElementById('cred-valor').value = '';
        new bootstrap.Modal(document.getElementById('modalCredito')).show();
    }

    async function atualizarCredito(fator) {
        if(isGuestMode) return;
        const id = document.getElementById('cred-id').value;
        const valInput = parseFloat(document.getElementById('cred-valor').value);
        if(!valInput || valInput <= 0) return;
        
        const cliente = fiados.find(f => f.id === id);
        let novoSaldo = (cliente.saldoCredito || 0) + (valInput * fator);
        if(novoSaldo < 0) novoSaldo = 0;

        await getUserRef("fiados").doc(id).update({ saldoCredito: novoSaldo });
        
        bootstrap.Modal.getInstance(document.getElementById('modalCredito')).hide();
        Swal.fire('Atualizado', `Novo saldo: ${formatCurrency(novoSaldo)}`, 'success');
    }

    function abrirModalNovoFiado() { if(isGuestMode) return; document.getElementById('novo-fiado-nome').value = ''; document.getElementById('novo-fiado-valor').value = 0; new bootstrap.Modal(document.getElementById('modalNovoFiado')).show(); }

    async function criarNovoFiado(btn) {
        if(isGuestMode) return;
        const nome = document.getElementById('novo-fiado-nome').value.trim();
        const valor = parseFloat(document.getElementById('novo-fiado-valor').value) || 0;
        const zap = document.getElementById('novo-fiado-zap').value;
        if(!nome) return;
        setLoading(btn, true);
        
        await getUserRef("fiados").add({ cliente: nome, zap: zap, valorRestante: valor, saldoCredito: 0, dataCompra: new Date().toISOString(), ultimaAtualizacao: new Date().toISOString() });
        setLoading(btn, false); bootstrap.Modal.getInstance(document.getElementById('modalNovoFiado')).hide();
    }

    function abrirModalPagarFiado(id, valor) { if(isGuestMode) return; document.getElementById('fiado-id').value = id; document.getElementById('fiado-valor-total').innerText = formatCurrency(valor); document.getElementById('fiado-valor-pagar').value = valor; new bootstrap.Modal(document.getElementById('modalPagarFiado')).show(); }

    async function confirmarRecebimentoFiado(btn) { 
        if(isGuestMode) return;
        const id = document.getElementById('fiado-id').value; 
        const valPago = parseFloat(document.getElementById('fiado-valor-pagar').value); 
        if(!valPago || valPago <= 0) return; 
        setLoading(btn, true); 
        
        let f = isDemoMode ? fiados.find(x=>x.id===id) : (await getUserRef("fiados").doc(id).get()).data();
        
        const novaDivida = Math.max(0, f.valorRestante - valPago);
        let novoCredito = f.saldoCredito || 0;
        if (valPago > f.valorRestante) { 
            const troco = valPago - f.valorRestante; 
            if(confirm(`Valor pago excede a d√≠vida em ${formatCurrency(troco)}. Adicionar como cr√©dito?`)) novoCredito += troco; 
        }
        
        const batch = isDemoMode ? MockDB : db.batch();
        batch.update(getUserRef("fiados").doc(id), { valorRestante: novaDivida, saldoCredito: novoCredito, ultimaAtualizacao: new Date().toISOString() }); 
        batch.set(getUserRef("financas").doc(), { tipo: 'entrada', desc: `Recebimento Fiado - ${f.cliente}`, metodo: 'Dinheiro', valor: valPago, dataISO: new Date().toISOString()});
        
        if(!isDemoMode) await batch.commit();
        setLoading(btn, false); bootstrap.Modal.getInstance(document.getElementById('modalPagarFiado')).hide(); Swal.fire('Sucesso', 'Valor recebido!', 'success'); 
    }

    // RELAT√ìRIOS
    function renderRelatorios() {
        let rec=0, desp=0; financas.forEach(f => f.tipo==='entrada'?rec+=f.valor:desp+=f.valor);
        document.getElementById('rel-receita').innerText = formatCurrency(rec);
        document.getElementById('rel-despesa').innerText = formatCurrency(desp);
        document.getElementById('rel-lucro').innerText = formatCurrency(rec-desp);
        document.getElementById('rel-margem').innerText = rec>0 ? ((rec-desp)/rec*100).toFixed(0)+'%' : '0%';
        document.getElementById('rel-detalhes').innerHTML = financas.slice(0,20).map(f => `<tr><td>${formatDate(f.dataISO)}</td><td>${esc(f.desc)}</td><td><span class="badge ${f.tipo==='entrada'?'bg-success':'bg-danger'}">${f.tipo}</span></td><td class="text-end">${formatCurrency(f.valor)}</td></tr>`).join('');
        if(chartFin) chartFin.destroy(); if(chartMet) chartMet.destroy();
        const fluxoData = {}; financas.forEach(f => { const dia = formatDate(f.dataISO); if(!fluxoData[dia]) fluxoData[dia] = 0; fluxoData[dia] += (f.tipo==='entrada'?f.valor:-f.valor); });
        chartFin = new Chart(document.getElementById('graficoFinanceiro'), { type: 'line', data: { labels: Object.keys(fluxoData).slice(-7), datasets: [{ label: 'Saldo', data: Object.values(fluxoData).slice(-7), borderColor: '#4f46e5', tension: 0.3, fill: true, backgroundColor: 'rgba(79, 70, 229, 0.1)' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} } } });
        const metodosData = {}; financas.filter(f=>f.tipo==='entrada').forEach(f => { const m = f.metodo || 'Outros'; if(!metodosData[m]) metodosData[m]=0; metodosData[m]+=f.valor; });
        chartMet = new Chart(document.getElementById('graficoMetodos'), { type: 'doughnut', data: { labels: Object.keys(metodosData), datasets: [{ data: Object.values(metodosData), backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {position: 'bottom'} } } });
    }

    // IA INTERATIVA
    function setupVoiceRecognition() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false; recognition.lang = 'pt-BR'; recognition.interimResults = false;
            recognition.onresult = function(event) { document.getElementById('chat-input').value = event.results[0][0].transcript; enviarMsgIA(); };
        } else { document.getElementById('btn-mic').style.display = 'none'; }
    }
    function toggleMic() { if(recognition) recognition.start(); }
    function setIAMode(mode) { iaMode = mode; document.getElementById('chat-output').innerHTML = ''; if(mode === 'comando') appendMsg('bot', '<b>IA Interativa</b>:<br>Fale "Vendi cabo p2".'); }

    async function enviarMsgIA() {
        const inp = document.getElementById('chat-input'); const msg = inp.value; if(!msg) return;
        appendMsg('user', esc(msg)); inp.value = ''; 
        // Simula√ß√£o b√°sica para n√£o quebrar sem API Key
        appendMsg('bot', 'Comando recebido (L√≥gica IA).');
    }

    function appendMsg(role, html) { const div = document.createElement('div'); div.className = `chat-msg chat-${role} fade-in`; div.innerHTML = html; const c = document.getElementById('chat-output'); c.appendChild(div); c.scrollTop = c.scrollHeight; }

    // DEMAIS FUN√á√ïES
    const formatCurrency = v => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v);
    const formatDate = d => new Date(d).toLocaleDateString('pt-BR');
    function selectPagamento(tipo, elem) { document.getElementById('pag-metodo').value = tipo; document.querySelectorAll('.btn-pagamento').forEach(b => b.classList.remove('active')); elem.classList.add('active'); if(tipo==='Fiado') document.getElementById('cliente-pdv').focus(); }
    async function addData(col,d,btn){ if(isGuestMode)return; if(btn)setLoading(btn,true); await getUserRef(col).add(d); if(btn){setLoading(btn,false); bootstrap.Modal.getInstance(btn.closest('.modal')).hide(); Swal.fire({toast:true,icon:'success',title:'Salvo',position:'top-end',showConfirmButton:false,timer:1000});} }
    function del(col,id){ if(isGuestMode)return; Swal.fire({title:'Excluir?',icon:'warning',showCancelButton:true,confirmButtonColor:'#d33'}).then(r=>{if(r.isConfirmed)getUserRef(col).doc(id).delete()}) }
    function carregarConfigUI() { document.getElementById('conf-nome').value=configEmpresa.nome||''; document.getElementById('conf-cnpj').value=configEmpresa.cnpj||''; document.getElementById('conf-end').value=configEmpresa.end||''; document.getElementById('conf-msg').value=configEmpresa.msg||''; document.getElementById('conf-apikey').value=configEmpresa.apikey||''; }
    async function salvarConfig(btn) { if(isGuestMode)return; setLoading(btn,true); const cfg={ nome:document.getElementById('conf-nome').value, cnpj:document.getElementById('conf-cnpj').value, end:document.getElementById('conf-end').value, msg:document.getElementById('conf-msg').value, apikey:document.getElementById('conf-apikey').value, }; await getConfigRef().set(cfg); setLoading(btn,false); location.reload(); }
    
    // GERA√á√ÉO DE LINK VISITANTE
    function gerarLinkVisitante() {
        if(!currentUser || isDemoMode) return Swal.fire('Aviso', 'Fa√ßa login real para gerar link.', 'warning');
        const link = `${window.location.protocol}//${window.location.host}${window.location.pathname}?mode=guest&uid=${currentUser.uid}`;
        document.getElementById('link-visitante').value = link;
    }
    function copiarLinkVisitante() {
        const linkInput = document.getElementById('link-visitante');
        if(!linkInput.value) return;
        linkInput.select(); document.execCommand('copy');
        Swal.fire('Copiado!', 'Envie este link para quem quiser que veja seu sistema (somente leitura).', 'success');
    }

    function navTo(id) { document.querySelectorAll('.section').forEach(el=>el.classList.add('hide')); document.getElementById(id).classList.remove('hide'); toggleMenu(true); if(id==='dashboard') atualizarDashboard(); if(id==='estoque') renderEstoque(); if(id==='relatorios') renderRelatorios(); }
    function toggleMenu(force){ const sb=document.getElementById('sidebar'), ov=document.getElementById('overlay'); if(force){sb.classList.remove('show');ov.classList.remove('show')}else{sb.classList.toggle('show');ov.classList.toggle('show')} }
    
    async function resetarSistema() {
        if(isGuestMode) return;
        if(isDemoMode) { location.reload(); return; }
        const { value: confirmacao } = await Swal.fire({ title: 'TEM CERTEZA?', text: "Isso apagar√° TODOS os dados. Digite DELETAR para confirmar.", input: 'text', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Apagar Tudo' });
        if (confirmacao === 'DELETAR') {
            const batch = db.batch();
            ["produtos", "financas", "historico", "fiados", "os", "contas"].forEach(async col => {
                const snapshot = await getUserRef(col).get();
                snapshot.docs.forEach(doc => batch.delete(doc.ref));
            });
            await batch.commit();
            location.reload();
        }
    }

    // ESTOQUE
    function renderEstoque(){ 
        const t=document.getElementById('lista-estoque'); 
        const termo = norm(document.getElementById('busca-estoque').value); 
        t.innerHTML = produtos.filter(p => !termo || norm(p.nome).includes(termo)).map(p => { 
            const m = p.venda>0?(((p.venda-p.custo)/p.venda)*100).toFixed(0):0; 
            return `<tr>
                <td class="ps-4"><span class="fw-bold">${esc(p.nome)}</span></td>
                <td><span class="badge ${p.qtd<=(p.min||5)?'bg-danger':'bg-success'}">${p.qtd}</span></td>
                <td>${formatCurrency(p.custo)}</td>
                <td>${formatCurrency(p.venda)}</td>
                <td class="fw-bold ${m<30?'text-danger':'text-success'}">${m}%</td>
                <td class="text-end pe-4">
                    <button class="btn btn-sm btn-light text-primary me-1 admin-only" onclick="abrirModalEditarProduto('${p.id}')"><i class="fas fa-pen"></i></button>
                    <button class="btn btn-sm btn-light text-danger admin-only" onclick="del('produtos','${p.id}')"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`; 
        }).join(''); 
    }
    
    function abrirModalProduto(){ if(isGuestMode)return; document.getElementById('modal-prod-titulo').innerText = "Novo Produto"; document.getElementById('prod-id').value = ''; document.getElementById('prod-nome').value=''; document.getElementById('prod-qtd').value=''; document.getElementById('prod-min').value='5'; document.getElementById('prod-custo').value=''; document.getElementById('prod-venda').value=''; new bootstrap.Modal(document.getElementById('modalProduto')).show(); }
    function abrirModalEditarProduto(id) { if(isGuestMode)return; const p = produtos.find(x => x.id === id); document.getElementById('modal-prod-titulo').innerText = "Editar Produto"; document.getElementById('prod-id').value = id; document.getElementById('prod-nome').value = p.nome; document.getElementById('prod-qtd').value = p.qtd; document.getElementById('prod-min').value = p.min || 5; document.getElementById('prod-custo').value = p.custo; document.getElementById('prod-venda').value = p.venda; new bootstrap.Modal(document.getElementById('modalProduto')).show(); }
    async function salvarProduto(btn){ if(isGuestMode)return; const id = document.getElementById('prod-id').value; const nome=document.getElementById('prod-nome').value; const qtd=parseInt(document.getElementById('prod-qtd').value)||0; const custo=parseFloat(document.getElementById('prod-custo').value)||0; const venda=parseFloat(document.getElementById('prod-venda').value)||0; const min=parseInt(document.getElementById('prod-min').value)||5; if(!nome)return; setLoading(btn, true); if(id) { await getUserRef("produtos").doc(id).update({nome, qtd, custo, venda, min}); } else { await getUserRef("produtos").add({nome, qtd, custo, venda, min}); } setLoading(btn, false); bootstrap.Modal.getInstance(document.getElementById('modalProduto')).hide(); }

    function renderFinancas(){ const t=document.getElementById('lista-financa'); const termo = norm(document.getElementById('busca-financa').value); t.innerHTML = financas.filter(f => !termo || norm(f.desc).includes(termo)).map(f => `<tr><td class="ps-4"><i class="fas ${f.tipo==='entrada'?'fa-arrow-up text-success':'fa-arrow-down text-danger'}"></i></td><td>${esc(f.desc)}</td><td class="fw-bold ${f.tipo==='entrada'?'text-success':'text-danger'}">${formatCurrency(f.valor)}</td><td>${formatDate(f.dataISO)}</td><td class="text-end pe-4"><button class="btn btn-sm btn-light text-danger admin-only" onclick="del('financas','${f.id}')"><i class="fas fa-trash"></i></button></td></tr>`).join(''); }
    function salvarFinanca(btn){ const v=parseFloat(document.getElementById('fin-valor').value); if(!v)return; addData('financas', {tipo:document.getElementById('fin-tipo').value, desc:document.getElementById('fin-desc').value, valor:v, dataISO:new Date().toISOString(), metodo:'Manual'}, btn); }

    // OS
    function renderOS(){ const c=document.getElementById('lista-os'); c.innerHTML = osList.map(o => `<tr><td class="ps-4 fw-bold">${esc(o.cliente)}</td><td><small class="text-muted">${esc(o.desc).substring(0,30)}...</small></td><td>${o.prazo ? formatDate(o.prazo) : '-'}</td><td class="fw-bold text-primary">${o.valor > 0 ? formatCurrency(o.valor) : 'A OR√áAR'}</td><td>${o.concluido?'<span class="badge bg-success">Conclu√≠do</span>':'<span class="badge bg-warning text-dark">Pendente</span>'}</td><td class="text-end pe-4">${!o.concluido?`<button class="btn btn-sm btn-outline-success rounded-pill me-1 admin-only" onclick="concluirOS('${o.id}', ${o.valor}, '${esc(o.cliente)}')"><i class="fas fa-check"></i></button>`:''}<button class="btn btn-sm btn-light text-primary me-1 admin-only" onclick="abrirModalEditarOS('${o.id}')"><i class="fas fa-pen"></i></button><button class="btn btn-sm btn-light text-danger admin-only" onclick="del('os','${o.id}')"><i class="fas fa-trash"></i></button></td></tr>`).join(''); }
    function abrirModalOS(){ if(isGuestMode)return; new bootstrap.Modal(document.getElementById('modalOS')).show(); }
    function salvarOS(btn){ const val = parseFloat(document.getElementById('os-valor').value)||0; addData("os",{cliente:document.getElementById('os-cliente').value,desc:document.getElementById('os-desc').value,valor:val,prazo:document.getElementById('os-data').value,dataCriacao:new Date().toISOString(),concluido:false},btn); }
    async function concluirOS(id, valor, cliente) { if(isGuestMode)return; if(!confirm('Confirmar conclus√£o?')) return; const batch = isDemoMode ? MockDB : db.batch(); batch.update(getUserRef("os").doc(id), {concluido: true}); if(valor > 0) { batch.set(getUserRef("financas").doc(), {tipo:'entrada', desc:`Servi√ßo O.S. - ${cliente}`, metodo:'Dinheiro', valor:valor, dataISO:new Date().toISOString()}); } if(!isDemoMode) await batch.commit(); Swal.fire('Conclu√≠do', 'OS Fechada.', 'success'); }
    function abrirModalEditarOS(id) { if(isGuestMode)return; const o = osList.find(i => i.id === id); document.getElementById('edit-os-id').value = id; document.getElementById('edit-os-cliente').value = o.cliente; document.getElementById('edit-os-desc').value = o.desc; document.getElementById('edit-os-valor').value = o.valor; document.getElementById('edit-os-data').value = o.prazo || ''; new bootstrap.Modal(document.getElementById('modalEditarOS')).show(); }
    async function salvarEdicaoOS(btn) { if(isGuestMode)return; setLoading(btn, true); const id = document.getElementById('edit-os-id').value; const desc = document.getElementById('edit-os-desc').value; const valor = parseFloat(document.getElementById('edit-os-valor').value) || 0; const prazo = document.getElementById('edit-os-data').value; await getUserRef("os").doc(id).update({ desc, valor, prazo }); setLoading(btn, false); bootstrap.Modal.getInstance(document.getElementById('modalEditarOS')).hide(); Swal.fire('Atualizado', 'Ordem de Servi√ßo editada.', 'success'); }

    // CONTAS (COM BOT√ÉO EDITAR NOVO)
    function renderContas() { 
        const t = document.getElementById('lista-contas'); 
        t.innerHTML = contas.map(c => `<tr>
            <td class="ps-4">${c.venc}</td>
            <td>${esc(c.desc)} ${c.recorrente ? '<i class="fas fa-sync-alt text-muted ms-1" title="Mensal"></i>' : ''}</td>
            <td class="fw-bold">${formatCurrency(c.valor)}</td>
            <td><span class="badge bg-warning text-dark">Pendente</span></td>
            <td class="text-end pe-4">
                <button class="btn btn-sm btn-success rounded-circle admin-only" onclick="pagarConta('${c.id}')"><i class="fas fa-check"></i></button> 
                <button class="btn btn-sm btn-light text-primary me-1 admin-only" onclick="abrirModalEditarConta('${c.id}')" title="Editar"><i class="fas fa-pen"></i></button>
                <button class="btn btn-sm btn-light text-danger rounded-circle admin-only" onclick="del('contas','${c.id}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`).join(''); 
    }

    // FUN√á√ïES DE EDI√á√ÉO CONTA
    function abrirModalEditarConta(id) {
        if(isGuestMode) return;
        const c = contas.find(x => x.id === id);
        document.getElementById('edit-conta-id').value = id;
        document.getElementById('edit-conta-desc').value = c.desc;
        document.getElementById('edit-conta-valor').value = c.valor;
        document.getElementById('edit-conta-venc').value = c.venc;
        new bootstrap.Modal(document.getElementById('modalEditarConta')).show();
    }

    async function salvarEdicaoConta(btn) {
        if(isGuestMode) return;
        setLoading(btn, true);
        const id = document.getElementById('edit-conta-id').value;
        const desc = document.getElementById('edit-conta-desc').value;
        const valor = parseFloat(document.getElementById('edit-conta-valor').value);
        const venc = document.getElementById('edit-conta-venc').value;
        await getUserRef("contas").doc(id).update({ desc, valor, venc });
        setLoading(btn, false);
        bootstrap.Modal.getInstance(document.getElementById('modalEditarConta')).hide();
        Swal.fire('Atualizado', 'Conta salva.', 'success');
    }

    function abrirModalConta() { if(isGuestMode)return; document.getElementById('conta-desc').value = ''; document.getElementById('conta-valor').value = ''; document.getElementById('conta-venc').value = ''; document.getElementById('conta-recorrente').checked = false; new bootstrap.Modal(document.getElementById('modalConta')).show(); }
    async function salvarConta(btn) { if(isGuestMode)return; const desc = document.getElementById('conta-desc').value; const valor = parseFloat(document.getElementById('conta-valor').value); const venc = document.getElementById('conta-venc').value; const recorrente = document.getElementById('conta-recorrente').checked; if(!desc || !valor || !venc) return Swal.fire('Erro', 'Preencha todos os campos', 'warning'); addData("contas", {desc, valor, venc, recorrente}, btn); }
    async function pagarConta(id) { if(isGuestMode)return; if(!confirm('Confirmar pagamento?')) return; const c = contas.find(x => x.id === id); await getUserRef("contas").doc(id).delete(); await getUserRef("financas").add({tipo:'saida', desc:`Pagamento: ${c.desc}`, metodo:'Dinheiro', valor: c.valor, dataISO:new Date().toISOString()}); if(c.recorrente) { let nextDate; if(c.venc.includes('-')) { const parts = c.venc.split('-'); nextDate = new Date(parts[0], parts[1]-1, parts[2]); } else { const parts = c.venc.split('/'); nextDate = new Date(parts[2], parts[1]-1, parts[0]); } nextDate.setMonth(nextDate.getMonth() + 1); await getUserRef("contas").add({ desc: c.desc, valor: c.valor, venc: nextDate.toISOString().split('T')[0], recorrente: true }); } Swal.fire('Pago', 'Conta baixada.', 'success'); }

    function imprimirExtrato() { const tabela = document.getElementById('tabela-extrato').outerHTML; const html = `<div style="text-align:center; margin-bottom:20px;"><h3>${esc(configEmpresa.nome)}</h3><p>Relat√≥rio Detalhado</p><hr></div>${tabela}<div style="margin-top:20px; text-align:right;">Emitido em: ${new Date().toLocaleString()}</div>`; imprimirConteudo(html); }
    function imprimirConteudo(html) { const area = document.getElementById('area-impressao'); area.innerHTML = html; area.classList.remove('hide'); setTimeout(() => { window.print(); setTimeout(() => area.classList.add('hide'), 500); }, 100); }
    function exportarDados(tipo) { let dados = tipo === 'produtos' ? produtos : financas; let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; if(tipo === 'produtos') { csvContent += "Nome,Quantidade,Custo,Venda\n"; dados.forEach(d => { csvContent += `"${d.nome}",${d.qtd},${d.custo},${d.venda}\n`; }); } else { csvContent += "Data,Descri√ß√£o,Tipo,Valor,M√©todo\n"; dados.forEach(d => { csvContent += `"${formatDate(d.dataISO)}","${d.desc}",${d.tipo},${d.valor},"${d.metodo}"\n`; }); } const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", `relatorio_${tipo}.csv`); document.body.appendChild(link); link.click(); }
    function processarImagemOCR(input) { if(isGuestMode)return; const file = input.files[0]; if(!file) return; document.getElementById('ocr-progress').classList.remove('hide'); const origem = document.getElementById('ocr-origem').value; Tesseract.recognize(file, 'por').then(({ data: { text } }) => { document.getElementById('ocr-progress').classList.add('hide'); bootstrap.Modal.getInstance(document.getElementById('modalOCR')).hide(); const valorMatch = text.match(/R\$\s?([\d,.]+)/i); let valor = valorMatch ? parseFloat(valorMatch[1].replace('.','').replace(',','.')) : 0; if(origem === 'contas') { abrirModalConta(); setTimeout(() => { document.getElementById('conta-valor').value = valor; Swal.fire({toast:true, icon:'success', title:'Leitura OK', position:'top'}); }, 500); } }); }
    function abrirModalOCR(origem) { if(isGuestMode)return; document.getElementById('ocr-origem').value = origem; document.getElementById('ocr-result').classList.add('hide'); document.getElementById('ocr-file').value = ''; new bootstrap.Modal(document.getElementById('modalOCR')).show(); }

    navTo('dashboard');
</script>
</body>
</html>