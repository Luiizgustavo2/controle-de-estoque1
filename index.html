<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus ERP v9.1 - Ultimate Pro</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { 
            --primary-gradient: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            --bg-body: #f8f9fa; --surface: #ffffff;
            --text-main: #1f2937; --radius: 16px; 
            --shadow: 0 10px 25px -5px rgba(0,0,0,0.05), 0 8px 10px -6px rgba(0,0,0,0.01);
        }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-body); overflow-x: hidden; color: var(--text-main); }
        
        /* Sidebar */
        .sidebar { min-height: 100vh; background: var(--primary-gradient); color: white; transition: 0.3s; z-index: 1000; box-shadow: 5px 0 15px rgba(0,0,0,0.05); }
        .nav-link { color: rgba(255,255,255,0.8); margin: 5px 15px; border-radius: 12px; transition: 0.2s; padding: 12px 15px; display: flex; align-items: center; font-weight: 500; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.2); color: white; transform: translateX(5px); font-weight: 700; }
        .nav-link i { width: 25px; text-align: center; margin-right: 10px; font-size: 1.1em; }

        /* Cards & UI */
        .card-custom { border: none; border-radius: var(--radius); background: var(--surface); box-shadow: var(--shadow); overflow: hidden; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); cursor: default; }
        /* Efeito de destaque ao passar o mouse (Pedido) */
        .card-active:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 20px 30px -10px rgba(0,0,0,0.15); cursor: pointer; }
        
        .icon-box { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        
        .bg-green-soft { background-color: #d1fae5; color: #065f46; }
        .bg-red-soft { background-color: #fee2e2; color: #991b1b; }
        .bg-blue-soft { background-color: #dbeafe; color: #1e40af; }
        .bg-purple-soft { background-color: #ede9fe; color: #5b21b6; }
        .bg-yellow-soft { background-color: #fef3c7; color: #92400e; }

        /* Loader & Login */
        #global-loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:10000; display:flex; justify-content:center; align-items:center; }
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 40px; border-radius: 24px; box-shadow: var(--shadow); width: 100%; max-width: 400px; text-align: center; }

        /* Mobile */
        @media (max-width: 768px) {
            .sidebar { position: fixed; top: 0; left: -280px; height: 100vh; width: 260px; }
            .sidebar.show { left: 0; }
            .mobile-header { display: flex !important; justify-content: space-between; padding: 15px 20px; background: var(--primary-gradient); color: white; align-items: center; }
            .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; backdrop-filter: blur(2px); }
            .overlay.show { display: block; }
            main { padding-top: 20px !important; }
        }
        .mobile-header { display: none; }
        .hide { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* PDV & Cart */
        .pdv-product-card { cursor: pointer; border: 1px solid #f3f4f6; border-radius: 12px; }
        .pdv-product-card:hover { border-color: #6366f1; background-color: #f5f3ff; }
        .cart-area { background: var(--surface); border-radius: var(--radius); box-shadow: var(--shadow); height: calc(100vh - 40px); display: flex; flex-direction: column; position: sticky; top: 20px; }
        @media (max-width: 768px) { .cart-area { height: auto; min-height: 400px; position: relative; top: 0; margin-top: 20px; } }
        
        /* Input de Qtd no Carrinho */
        .qty-input { width: 40px; text-align: center; border: 1px solid #dee2e6; border-radius: 6px; margin: 0 5px; padding: 2px; font-weight: bold; font-size: 0.9rem; }
        .qty-input:focus { outline: none; border-color: #4f46e5; }
        /* Remove setas do input number */
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        /* Impress√£o */
        @media print { body * { visibility: hidden; } #cupom-fiscal, #cupom-fiscal * { visibility: visible; } #cupom-fiscal { position: absolute; left: 0; top: 0; width: 100%; } }
    </style>
</head>
<body>

<div id="global-loader" class="hide">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
</div>

<div id="login-screen">
    <div class="login-box fade-in">
        <div class="mb-4">
            <div class="bg-primary bg-opacity-10 d-inline-block p-3 rounded-circle mb-3">
                <i class="fas fa-layer-group fa-3x text-primary"></i>
            </div>
            <h2 class="fw-bold">NEXUS CLOUD</h2>
            <p class="text-muted small">Gest√£o completa e segura</p>
        </div>
        <input type="email" id="email-login" class="form-control form-control-lg mb-3 bg-light border-0" placeholder="E-mail">
        <input type="password" id="senha-login" class="form-control form-control-lg mb-3 bg-light border-0" placeholder="Senha">
        <div class="d-grid gap-2">
            <button onclick="tentarLogin(this)" class="btn btn-primary btn-lg fw-bold rounded-pill">ENTRAR</button>
            <button onclick="tentarCriarConta(this)" class="btn btn-outline-secondary btn-lg fw-bold rounded-pill">CRIAR CONTA</button>
        </div>
        <small class="text-muted mt-3 d-block" id="status-login"></small>
    </div>
</div>

<div class="overlay" id="overlay" onclick="toggleMenu()"></div>
<div class="mobile-header shadow-sm">
    <div class="fw-bold fs-4"><i class="fas fa-layer-group me-2"></i>NEXUS</div>
    <button class="btn btn-outline-light border-0" onclick="toggleMenu()"><i class="fas fa-bars fa-2x"></i></button>
</div>

<div class="container-fluid" id="app-content" style="filter: blur(5px);">
    <div class="row">
        <nav class="col-md-2 sidebar" id="sidebar">
            <div class="text-center py-4 text-uppercase fw-bold fs-4"><i class="fas fa-cloud me-2"></i> NEXUS</div>
            <div class="px-3 mb-4 text-center"><small class="text-white-50" id="user-display">...</small></div>
            <ul class="nav flex-column gap-1 px-2">
                <li class="nav-item"><a class="nav-link active" onclick="navTo('dashboard')"><i class="fas fa-home"></i> Vis√£o Geral</a></li>
                <li class="nav-item"><a class="nav-link" onclick="navTo('relatorios')"><i class="fas fa-chart-line"></i> Lucratividade</a></li>
                <li class="nav-item"><a class="nav-link" onclick="navTo('pdv')"><i class="fas fa-shopping-cart"></i> PDV (Vendas)</a></li>
                <li class="nav-item"><a class="nav-link" onclick="navTo('estoque')"><i class="fas fa-box-open"></i> Estoque</a></li>
                <li class="nav-item"><a class="nav-link" onclick="navTo('financeiro')"><i class="fas fa-wallet"></i> Financeiro</a></li>
                <li class="nav-item"><a class="nav-link" onclick="navTo('os')"><i class="fas fa-tools"></i> Servi√ßos (OS)</a></li>
                <li class="nav-item"><a class="nav-link" onclick="navTo('config')"><i class="fas fa-cog"></i> Configura√ß√µes</a></li>
                <hr class="border-white opacity-25 mx-3">
                <li class="nav-item"><a class="nav-link text-warning" href="https://amei.sebrae.com.br/auth/realms/externo/protocol/openid-connect/auth?client_id=emissor-nfe-frontend&redirect_uri=https%3A%2F%2Femissornfe.sebrae.com.br%2F&state=28df738b-d9e3-40b9-a73c-06454a67835e&response_mode=fragment&response_type=code&scope=openid&nonce=a05772c6-1765-44d4-8643-d794b2773559" target="_blank"><i class="fas fa-file-invoice"></i> Emissor Sebrae</a></li>
                <li class="nav-item mt-2"><a class="nav-link text-danger-emphasis" onclick="fazerLogout()"><i class="fas fa-sign-out-alt"></i> Sair</a></li>
            </ul>
        </nav>

        <main class="col-md-10 ms-sm-auto px-4 pt-4 pb-5">
            
            <div id="dashboard" class="section fade-in">
                <h3 class="fw-bold text-dark mb-4">Vis√£o Geral</h3>
                
                <div class="row g-3 mb-4">
                    <div class="col-6 col-md-3">
                        <div class="card card-custom card-active p-3 h-100" onclick="navTo('financeiro')">
                            <div class="d-flex justify-content-between align-items-start mb-2"><div class="icon-box bg-green-soft"><i class="fas fa-arrow-up"></i></div><small class="text-success fw-bold">+ M√™s</small></div>
                            <h6 class="text-muted mb-1 small">Receita</h6>
                            <h4 class="fw-bold mb-0" id="dash-entradas">R$ 0,00</h4>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card card-custom card-active p-3 h-100" onclick="navTo('financeiro')">
                            <div class="d-flex justify-content-between align-items-start mb-2"><div class="icon-box bg-red-soft"><i class="fas fa-arrow-down"></i></div><small class="text-danger fw-bold">- M√™s</small></div>
                            <h6 class="text-muted mb-1 small">Despesas</h6>
                            <h4 class="fw-bold mb-0" id="dash-saidas">R$ 0,00</h4>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card card-custom card-active p-3 h-100">
                            <div class="d-flex justify-content-between align-items-start mb-2"><div class="icon-box bg-blue-soft"><i class="fas fa-wallet"></i></div></div>
                            <h6 class="text-muted mb-1 small">Saldo Atual</h6>
                            <h4 class="fw-bold mb-0 text-primary" id="dash-saldo">R$ 0,00</h4>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card card-custom card-active p-3 h-100" onclick="verEstoqueCritico()">
                            <div class="d-flex justify-content-between align-items-start mb-2"><div class="icon-box bg-yellow-soft"><i class="fas fa-exclamation-triangle"></i></div></div>
                            <h6 class="text-muted mb-1 small">Cr√≠tico / Baixo</h6>
                            <h4 class="fw-bold mb-0 text-warning" id="dash-estoque-baixo">0</h4>
                        </div>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="card card-custom p-4 h-100">
                            <h6 class="fw-bold mb-3 text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Alertas de Estoque</h6>
                            <ul class="list-group list-group-flush small" id="lista-alertas">
                                <li class="list-group-item text-muted text-center py-4">Tudo certo por aqui!</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card card-custom p-4 h-100">
                            <h6 class="fw-bold mb-3">Movimenta√ß√µes Recentes</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover align-middle">
                                    <tbody id="dash-ultimas-movimentacoes"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="relatorios" class="section hide">
                <h3 class="fw-bold text-dark mb-4">An√°lise de Lucratividade</h3>
                <div class="row g-3 mb-4">
                    <div class="col-md-3"><div class="card card-custom p-3 text-white bg-success"><h6 class="opacity-75">Receita Total</h6><h3 class="fw-bold" id="rel-receita">R$ 0,00</h3></div></div>
                    <div class="col-md-3"><div class="card card-custom p-3 text-white bg-danger"><h6 class="opacity-75">Despesas</h6><h3 class="fw-bold" id="rel-despesa">R$ 0,00</h3></div></div>
                    <div class="col-md-3"><div class="card card-custom p-3 text-white bg-primary"><h6 class="opacity-75">Lucro L√≠quido</h6><h3 class="fw-bold" id="rel-lucro">R$ 0,00</h3></div></div>
                    <div class="col-md-3"><div class="card card-custom p-3 text-white" style="background: #7c3aed;"><h6 class="opacity-75">Margem</h6><h3 class="fw-bold" id="rel-margem">0%</h3></div></div>
                </div>
                <div class="row g-4">
                    <div class="col-md-8"><div class="card card-custom p-4"><h6 class="fw-bold mb-4">Receitas vs Despesas</h6><canvas id="graficoFinanceiro" height="150"></canvas></div></div>
                    <div class="col-md-4"><div class="card card-custom p-4 h-100"><h6 class="fw-bold mb-3">Formas de Pagamento</h6><canvas id="graficoMetodos" height="200"></canvas></div></div>
                </div>
            </div>

            <div id="pdv" class="section hide">
                <div class="row g-0">
                    <div class="col-md-8 pe-md-3 mb-4">
                        <div class="d-flex justify-content-between mb-3"><h3 class="fw-bold">PDV</h3><input type="text" id="pdv-search" class="form-control w-50 rounded-pill bg-white border-0 shadow-sm" placeholder="üîç Buscar produto..." onkeyup="renderPDVGrid()"></div>
                        <div class="row g-3" id="pdv-grid"></div>
                    </div>
                    <div class="col-md-4">
                        <div class="cart-area p-4">
                            <div class="d-flex justify-content-between align-items-center mb-3"><h5 class="fw-bold m-0">Carrinho</h5><button class="btn btn-sm btn-light text-danger rounded-circle" onclick="limparCarrinho()"><i class="fas fa-trash"></i></button></div>
                            <div class="cart-items" id="pdv-cart-items"></div>
                            <div class="mt-auto pt-3 border-top">
                                <div class="mb-2"><label class="small fw-bold text-muted">Desconto (R$)</label><input type="number" id="pdv-desconto" class="form-control" value="0" min="0" oninput="renderCarrinho()"></div>
                                <div class="d-flex justify-content-between h3 fw-bold mb-3"><span>Total</span><span id="pdv-total" class="text-primary">R$ 0,00</span></div>
                                <button class="btn btn-primary w-100 btn-lg rounded-pill fw-bold shadow-sm" onclick="abrirModalPagamento()">FINALIZAR VENDA</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="estoque" class="section hide">
                <div class="d-flex justify-content-between mb-4">
                    <h3 class="fw-bold">Estoque</h3>
                    <div>
                        <button class="btn btn-outline-secondary rounded-pill me-2 hide" id="btn-limpar-filtro" onclick="renderEstoque(false)">Ver Todos</button>
                        <button class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm" onclick="abrirModalProduto()"><i class="fas fa-plus me-2"></i> Novo Produto</button>
                    </div>
                </div>
                <div class="card card-custom p-0"><div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead class="bg-light text-muted small text-uppercase"><tr><th class="ps-4">Produto</th><th>Qtd</th><th>Custo</th><th>Venda</th><th>Margem</th><th class="text-end pe-4">A√ß√µes</th></tr></thead><tbody id="lista-estoque"></tbody></table></div></div>
            </div>

            <div id="financeiro" class="section hide">
                <div class="d-flex justify-content-between mb-4"><h3 class="fw-bold">Financeiro</h3><button class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm" onclick="abrirModalFinanca()"><i class="fas fa-plus me-2"></i> Lan√ßar</button></div>
                <div class="card card-custom p-0"><div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead class="bg-light text-muted small text-uppercase"><tr><th class="ps-4">Tipo</th><th>Desc</th><th>Valor</th><th>Data</th><th class="text-end pe-4">A√ß√µes</th></tr></thead><tbody id="lista-financa"></tbody></table></div></div>
            </div>
            
            <div id="config" class="section hide">
                <h3 class="fw-bold text-dark mb-4">Configura√ß√µes da Empresa</h3>
                <div class="row justify-content-center"><div class="col-md-8"><div class="card card-custom p-5"><div class="mb-4 text-center"><i class="fas fa-store fa-3x text-primary mb-2"></i><p class="text-muted">Dados para o Cupom Fiscal</p></div><div class="mb-3"><label>Nome da Loja</label><input type="text" id="conf-nome" class="form-control form-control-lg bg-light border-0"></div><div class="mb-3"><label>CNPJ</label><input type="text" id="conf-cnpj" class="form-control bg-light border-0"></div><div class="mb-3"><label>Endere√ßo</label><input type="text" id="conf-end" class="form-control bg-light border-0"></div><div class="mb-3"><label>Telefone/Zap</label><input type="text" id="conf-tel" class="form-control bg-light border-0"></div><div class="mb-3"><label>Rodap√© do Cupom</label><input type="text" id="conf-msg" class="form-control bg-light border-0"></div><button class="btn btn-success w-100 btn-lg rounded-pill fw-bold mt-3" onclick="salvarConfig(this)">SALVAR DADOS</button></div></div></div>
            </div>

            <div id="os" class="section hide">
                <div class="d-flex justify-content-between mb-4"><h3 class="fw-bold">Ordens de Servi√ßo</h3><button class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm" onclick="abrirModalOS()"><i class="fas fa-plus me-2"></i> Nova O.S.</button></div>
                <div class="row g-4" id="lista-os"></div>
            </div>
        </main>
    </div>
</div>

<div class="modal fade" id="modalPagamento" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 rounded-4"><div class="modal-body p-4 text-center"><h1 class="fw-bold mb-4" id="modal-pag-total">R$ 0,00</h1><select id="pag-metodo" class="form-select form-select-lg mb-3 bg-light border-0"><option>Dinheiro</option><option>PIX</option><option>Cart√£o de Cr√©dito</option><option>Cart√£o de D√©bito</option></select><button class="btn btn-success w-100 btn-lg rounded-pill fw-bold" onclick="processarVenda(this)">CONFIRMAR</button></div></div></div></div>
<div class="modal fade" id="modalProduto" tabindex="-1"><div class="modal-dialog"><div class="modal-content border-0 rounded-4"><div class="modal-body p-4"><input type="hidden" id="prod-id"><h5 class="fw-bold mb-3">Produto</h5><input type="text" id="prod-nome" class="form-control mb-3 bg-light border-0" placeholder="Nome do Produto"><div class="row g-2"><div class="col-6"><input type="number" id="prod-qtd" class="form-control bg-light border-0" placeholder="Qtd"></div><div class="col-6"><input type="number" id="prod-min" class="form-control bg-light border-0" placeholder="Min" value="5"></div><div class="col-6"><input type="number" id="prod-custo" class="form-control bg-light border-0" placeholder="Custo R$"></div><div class="col-6"><input type="number" id="prod-venda" class="form-control bg-light border-0" placeholder="Venda R$"></div></div><button class="btn btn-primary w-100 mt-4 rounded-pill fw-bold" onclick="salvarProduto(this)">SALVAR</button></div></div></div></div>
<div class="modal fade" id="modalFinanca" tabindex="-1"><div class="modal-dialog modal-sm"><div class="modal-content border-0 rounded-4"><div class="modal-body p-4"><h5 class="fw-bold mb-3">Lan√ßamento</h5><input type="text" id="fin-desc" class="form-control mb-2 bg-light border-0" placeholder="Descri√ß√£o"><select id="fin-tipo" class="form-select mb-2 bg-light border-0"><option value="entrada">Entrada</option><option value="saida">Sa√≠da</option></select><input type="number" id="fin-valor" class="form-control mb-3 bg-light border-0" placeholder="Valor"><button class="btn btn-success w-100 rounded-pill fw-bold" onclick="salvarFinanca(this)">SALVAR</button></div></div></div></div>
<div class="modal fade" id="modalOS" tabindex="-1"><div class="modal-dialog"><div class="modal-content border-0 rounded-4"><div class="modal-body p-4"><h5 class="fw-bold mb-3">Nova O.S.</h5><input type="text" id="os-cliente" class="form-control mb-2 bg-light border-0" placeholder="Nome do Cliente"><textarea id="os-desc" class="form-control mb-2 bg-light border-0" placeholder="Descri√ß√£o do Servi√ßo" rows="3"></textarea><div class="row g-2"><div class="col-6"><input type="number" id="os-valor" class="form-control bg-light border-0" placeholder="Valor"></div><div class="col-6"><input type="date" id="os-data" class="form-control bg-light border-0"></div></div><button class="btn btn-primary w-100 mt-4 rounded-pill fw-bold" onclick="salvarOS(this)">CRIAR O.S.</button></div></div></div></div>

<div id="cupom-fiscal" class="hide p-4 bg-white text-black" style="width: 300px; font-family: 'Courier New', monospace;">
    <div class="text-center mb-3">
        <h4 class="fw-bold" id="cp-nome">NEXUS ERP</h4>
        <small id="cp-dados">CNPJ: 00.000.000/0000-00<br>Rua Exemplo, 123</small>
        <hr style="border-top: 2px dashed black;">
    </div>
    <div id="cupom-itens" class="mb-3"></div>
    <hr style="border-top: 2px dashed black;">
    <div class="d-flex justify-content-between fw-bold fs-5"><span>TOTAL:</span><span id="cupom-total"></span></div>
    <div class="mt-4 text-center"><p class="mb-1">Pgto: <span id="cupom-pagamento"></span></p><small id="cp-msg">Obrigado pela prefer√™ncia!</small></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBHBFj0QRebascuwJ5LxprYeuFbk7KsiYc",
        authDomain: "nexus-erp-6998c.firebaseapp.com",
        projectId: "nexus-erp-6998c",
        storageBucket: "nexus-erp-6998c.firebasestorage.app",
        messagingSenderId: "599369243365",
        appId: "1:599369243365:web:3363fe65f3d36c00e1d20c",
        measurementId: "G-7NFRRWYYJ6"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let currentUser = null;
    let produtos = [], financas = [], osList = [], historico = [], carrinho = [];
    let configEmpresa = { nome: 'NEXUS ERP', cnpj: '', end: '', tel: '', msg: 'Volte Sempre!' };
    let chartFinanceiro = null, chartMetodos = null;

    function getUserRef(c) { return currentUser ? db.collection("users").doc(currentUser.uid).collection(c) : null; }
    function getConfigRef() { return currentUser ? db.collection("users").doc(currentUser.uid).collection("config").doc("geral") : null; }

    function setLoading(btn, isLoading) {
        if(isLoading) { btn.disabled=true; btn.orig=btn.innerHTML; btn.innerHTML='<span class="spinner-border spinner-border-sm"></span>'; } 
        else { btn.disabled=false; btn.innerHTML=btn.orig; }
    }

    // AUTH
    function tentarLogin(btn) { setLoading(btn,true); auth.signInWithEmailAndPassword(document.getElementById('email-login').value, document.getElementById('senha-login').value).catch(e=>{Swal.fire('Erro',e.message,'error'); setLoading(btn,false)}); }
    function tentarCriarConta(btn) { setLoading(btn,true); auth.createUserWithEmailAndPassword(document.getElementById('email-login').value, document.getElementById('senha-login').value).then(()=>{Swal.fire('Sucesso','','success')}).catch(e=>{Swal.fire('Erro',e.message,'error'); setLoading(btn,false)}); }
    function fazerLogout() { auth.signOut(); location.reload(); }

    auth.onAuthStateChanged(u => {
        if(u) { currentUser=u; document.getElementById('login-screen').classList.add('hide'); document.getElementById('app-content').style.filter='none'; document.getElementById('user-display').innerText=u.email; iniciarSistema(); }
        else { document.getElementById('login-screen').classList.remove('hide'); document.getElementById('app-content').style.filter='blur(5px)'; }
    });

    function iniciarSistema() {
        getUserRef("produtos").onSnapshot(s => { produtos = s.docs.map(d=>({id:d.id, ...d.data()})); renderEstoque(); renderPDVGrid(); atualizarDashboard(); });
        getUserRef("financas").orderBy("dataISO","desc").limit(100).onSnapshot(s => { financas = s.docs.map(d=>({id:d.id, ...d.data()})); renderFinancas(); atualizarDashboard(); renderRelatorios(); });
        getUserRef("os").onSnapshot(s => { osList = s.docs.map(d=>({id:d.id, ...d.data()})); renderOS(); });
        getUserRef("historico").orderBy("data","desc").limit(20).onSnapshot(s => { historico = s.docs.map(d=>({id:d.id, ...d.data()})); atualizarDashboard(); });
        getConfigRef().onSnapshot(s => { if(s.exists) { configEmpresa = s.data(); carregarConfigUI(); } });
    }

    // CONFIG
    function carregarConfigUI() {
        document.getElementById('conf-nome').value = configEmpresa.nome || '';
        document.getElementById('conf-cnpj').value = configEmpresa.cnpj || '';
        document.getElementById('conf-end').value = configEmpresa.end || '';
        document.getElementById('conf-tel').value = configEmpresa.tel || '';
        document.getElementById('conf-msg').value = configEmpresa.msg || '';
    }
    async function salvarConfig(btn) {
        setLoading(btn, true);
        const cfg = {
            nome: document.getElementById('conf-nome').value,
            cnpj: document.getElementById('conf-cnpj').value,
            end: document.getElementById('conf-end').value,
            tel: document.getElementById('conf-tel').value,
            msg: document.getElementById('conf-msg').value
        };
        await getConfigRef().set(cfg);
        setLoading(btn, false);
        Swal.fire('Configura√ß√£o Salva', '', 'success');
    }

    // DASHBOARD & CHARTS
    function atualizarDashboard() {
        let ent=0, sai=0, vlrEst=0;
        const mesAtual = new Date().getMonth();
        financas.filter(f=>new Date(f.dataISO).getMonth()===mesAtual).forEach(f=>{ f.tipo==='entrada'? ent+=f.valor : sai+=f.valor });
        produtos.forEach(p => vlrEst += (p.custo * p.qtd));

        document.getElementById('dash-entradas').innerText = formatCurrency(ent);
        document.getElementById('dash-saidas').innerText = formatCurrency(sai);
        document.getElementById('dash-saldo').innerText = formatCurrency(ent-sai);
        // Calcula cr√≠tico apenas para o n√∫mero do dashboard
        const critico = produtos.filter(p=>p.qtd <= (p.min || 5)).length;
        document.getElementById('dash-estoque-baixo').innerText = critico;

        // Alertas
        const alertas = produtos.filter(p => p.qtd <= p.min);
        const listaAlertas = document.getElementById('lista-alertas');
        listaAlertas.innerHTML = '';
        if(alertas.length === 0) listaAlertas.innerHTML = '<li class="list-group-item text-muted text-center py-3">Tudo certo por aqui!</li>';
        else {
            alertas.slice(0,5).forEach(p => {
                listaAlertas.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center"><span class="fw-bold text-dark">${p.nome}</span><span class="badge ${p.qtd===0?'bg-danger':'bg-warning text-dark'}">${p.qtd} un</span></li>`;
            });
        }

        // Hist√≥rico "Vazio"
        const tb = document.getElementById('dash-ultimas-movimentacoes'); tb.innerHTML = '';
        if(historico.length === 0) {
            tb.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">Nenhuma movimenta√ß√£o recente</td></tr>';
        } else {
            historico.slice(0,5).forEach(h => {
                tb.innerHTML += `<tr><td><span class="badge bg-light text-dark border">${h.tipo}</span></td><td>${h.desc}</td><td class="fw-bold">${formatCurrency(h.valor)}</td></tr>`;
            });
        }
    }

    // ESTOQUE - Fun√ß√µes
    function verEstoqueCritico() {
        navTo('estoque');
        renderEstoque(true); // Ativa filtro
    }

    function renderEstoque(apenasCritico = false){ 
        const t=document.getElementById('lista-estoque'); t.innerHTML=''; 
        const btnFiltro = document.getElementById('btn-limpar-filtro');
        
        // Controle do bot√£o de "Ver Todos"
        if(apenasCritico) btnFiltro.classList.remove('hide');
        else btnFiltro.classList.add('hide');

        produtos.forEach(p=>{
            // L√≥gica do filtro
            if(apenasCritico && p.qtd > (p.min || 5)) return;

            const m = p.venda>0?(((p.venda-p.custo)/p.venda)*100).toFixed(0):0;
            t.innerHTML+=`<tr><td class="ps-4"><span class="fw-bold">${p.nome}</span></td><td><span class="badge ${p.qtd<=(p.min||5)?'bg-danger':'bg-success'}">${p.qtd}</span></td><td>${formatCurrency(p.custo)}</td><td>${formatCurrency(p.venda)}</td><td class="fw-bold ${m<30?'text-danger':'text-success'}">${m}%</td><td class="text-end pe-4"><button class="btn btn-sm btn-light text-danger" onclick="del('produtos','${p.id}')"><i class="fas fa-trash"></i></button></td></tr>`;
        }) 
    }

    // RELAT√ìRIOS (Sem altera√ß√£o l√≥gica, s√≥ visual mantido)
    function renderRelatorios() {
        let ent=0, sai=0; financas.forEach(f => f.tipo==='entrada'? ent+=f.valor : sai+=f.valor);
        const luc = ent - sai; const marg = ent>0 ? ((luc/ent)*100).toFixed(0) : 0;
        
        document.getElementById('rel-receita').innerText = formatCurrency(ent);
        document.getElementById('rel-despesa').innerText = formatCurrency(sai);
        document.getElementById('rel-lucro').innerText = formatCurrency(luc);
        document.getElementById('rel-margem').innerText = marg + '%';

        const ctx1 = document.getElementById('graficoFinanceiro').getContext('2d');
        const ctx2 = document.getElementById('graficoMetodos').getContext('2d');
        
        if(chartFinanceiro) chartFinanceiro.destroy();
        chartFinanceiro = new Chart(ctx1, { type: 'line', data: { labels: financas.slice(0,7).map(f=>formatDate(f.dataISO)).reverse(), datasets: [{label: 'Movimenta√ß√£o', data: financas.slice(0,7).map(f=>f.valor).reverse(), borderColor: '#4f46e5', tension: 0.4}] }, options: { plugins: {legend: {display: false}}, scales: { x: {display:false}, y: {display:false} } } });

        const metodos = {}; financas.filter(f=>f.tipo==='entrada').forEach(f => { metodos[f.metodo] = (metodos[f.metodo]||0) + f.valor });
        if(chartMetodos) chartMetodos.destroy();
        chartMetodos = new Chart(ctx2, { type: 'doughnut', data: { labels: Object.keys(metodos), datasets: [{data: Object.values(metodos), backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#6366f1']}] }, options: { cutout: '70%', plugins: {legend: {position: 'bottom'}} } });
    }

    // OPERA√á√ïES GERAIS
    function navTo(id) { document.querySelectorAll('.section').forEach(el=>el.classList.add('hide')); document.getElementById(id).classList.remove('hide'); toggleMenu(true); if(id==='dashboard') atualizarDashboard(); if(id==='estoque') renderEstoque(false); }
    function toggleMenu(force){ const sb=document.getElementById('sidebar'), ov=document.getElementById('overlay'); if(force){sb.classList.remove('show');ov.classList.remove('show')}else{sb.classList.toggle('show');ov.classList.toggle('show')} }
    const formatCurrency = v => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v);
    const formatDate = d => new Date(d).toLocaleDateString('pt-BR');
    async function log(t,d,v){ await getUserRef("historico").add({tipo:t,desc:d,valor:v,data:new Date().toISOString()}) }

    // MODAIS DE CADASTRO
    function abrirModalProduto(){ document.getElementById('prod-nome').value=''; new bootstrap.Modal(document.getElementById('modalProduto')).show(); }
    function salvarProduto(btn){
        const nome=document.getElementById('prod-nome').value; if(!nome) return;
        addData("produtos", {nome, qtd:parseInt(document.getElementById('prod-qtd').value)||0, custo:parseFloat(document.getElementById('prod-custo').value)||0, venda:parseFloat(document.getElementById('prod-venda').value)||0, min:parseInt(document.getElementById('prod-min').value)||5}, btn);
        log('Estoque', `Novo: ${nome}`, 0);
    }

    // PDV - CARRINHO COM +/- e INPUT
    function renderPDVGrid(){
        const c=document.getElementById('pdv-grid'); c.innerHTML=''; const s=document.getElementById('pdv-search').value.toLowerCase();
        produtos.forEach(p=>{ if(p.nome.toLowerCase().includes(s)) c.innerHTML+=`<div class="col-6 col-lg-4"><div class="card p-3 pdv-product-card h-100" onclick="addCart('${p.id}')"><div class="d-flex justify-content-between mb-2"><span class="badge bg-light text-secondary border">Est: ${p.qtd}</span></div><div class="fw-bold mb-1 text-truncate">${p.nome}</div><div class="h5 text-primary fw-bold">${formatCurrency(p.venda)}</div></div></div>` });
    }
    
    function addCart(id){ 
        const p=produtos.find(x=>x.id===id), i=carrinho.find(c=>c.id===id); 
        if(p.qtd<=(i?i.qty:0)) return Swal.fire({toast:true,icon:'error',title:'Estoque insuficiente',timer:1000,showConfirmButton:false}); 
        i?i.qty++:carrinho.push({...p,qty:1}); 
        renderCart(); 
    }

    function updateCartQty(id, delta) {
        const item = carrinho.find(c => c.id === id);
        if(!item) return;
        
        const p = produtos.find(x => x.id === id);
        const novaQtd = item.qty + delta;

        if(novaQtd > p.qtd) return Swal.fire({toast:true,icon:'warning',title:'M√°ximo atingido',timer:1000,showConfirmButton:false});
        if(novaQtd <= 0) {
            carrinho = carrinho.filter(c => c.id !== id);
        } else {
            item.qty = novaQtd;
        }
        renderCart();
    }

    function setCartQty(id, val) {
        const item = carrinho.find(c => c.id === id);
        if(!item) return;
        
        let novaQtd = parseInt(val);
        const p = produtos.find(x => x.id === id);

        if(isNaN(novaQtd) || novaQtd <= 0) novaQtd = 1;
        if(novaQtd > p.qtd) {
            novaQtd = p.qtd;
            Swal.fire({toast:true,icon:'warning',title:'Estoque limitado a '+p.qtd,timer:1500,showConfirmButton:false});
        }
        
        item.qty = novaQtd;
        renderCart();
    }

    function renderCart(){
        const c=document.getElementById('pdv-cart-items'); c.innerHTML=''; let sub=0;
        
        carrinho.forEach(i=>{ 
            sub+=i.venda*i.qty; 
            c.innerHTML+=`
            <div class="d-flex justify-content-between align-items-center mb-2 bg-light p-2 rounded">
                <div style="width:35%" class="text-truncate fw-bold small">${i.nome}</div>
                <div class="d-flex align-items-center">
                    <button class="btn btn-sm btn-white border px-2" onclick="updateCartQty('${i.id}', -1)">-</button>
                    <input type="number" class="qty-input" value="${i.qty}" onchange="setCartQty('${i.id}', this.value)">
                    <button class="btn btn-sm btn-white border px-2" onclick="updateCartQty('${i.id}', 1)">+</button>
                </div>
                <div class="fw-bold small text-end" style="width:25%">${formatCurrency(i.venda*i.qty)}</div>
            </div>`; 
        });

        const tot = Math.max(0, sub - (parseFloat(document.getElementById('pdv-desconto').value)||0));
        document.getElementById('pdv-total').innerText=formatCurrency(tot); 
        document.getElementById('modal-pag-total').innerText=formatCurrency(tot);
    }
    
    function limparCarrinho(){ carrinho=[]; renderCart(); }
    function abrirModalPagamento(){ if(carrinho.length) new bootstrap.Modal(document.getElementById('modalPagamento')).show(); }
    
    async function processarVenda(btn){
        setLoading(btn,true); const met=document.getElementById('pag-metodo').value; const batch=db.batch(); let sub=0, cupom='';
        carrinho.forEach(i=>{ const p=produtos.find(x=>x.id===i.id); if(p){ batch.update(getUserRef("produtos").doc(p.id),{qtd:p.qtd-i.qty}); sub+=i.venda*i.qty; cupom+=`<div class="d-flex justify-content-between small"><span>${i.qty}x ${i.nome}</span><span>${formatCurrency(i.venda*i.qty)}</span></div>` } });
        await batch.commit();
        const tot = Math.max(0, sub - (parseFloat(document.getElementById('pdv-desconto').value)||0));
        await addData("financas", {tipo:'entrada',desc:`Venda PDV`,metodo:met,valor:tot,dataISO:new Date().toISOString()}, null);
        await log('Venda', `Venda ${carrinho.length} itens`, tot);
        
        document.getElementById('cp-nome').innerText = configEmpresa.nome || 'NEXUS ERP';
        document.getElementById('cp-dados').innerHTML = `${configEmpresa.cnpj||''}<br>${configEmpresa.end||''}<br>${configEmpresa.tel||''}`;
        document.getElementById('cp-msg').innerText = configEmpresa.msg || 'Volte Sempre!';
        document.getElementById('cupom-itens').innerHTML = cupom;
        document.getElementById('cupom-total').innerText = formatCurrency(tot);
        document.getElementById('cupom-pagamento').innerText = met;
        
        setLoading(btn,false); bootstrap.Modal.getInstance(document.getElementById('modalPagamento')).hide();
        window.print(); limparCarrinho();
    }

    // FINANCEIRO & OS
    function abrirModalFinanca(){ new bootstrap.Modal(document.getElementById('modalFinanca')).show(); }
    function salvarFinanca(btn){ addData("financas",{desc:document.getElementById('fin-desc').value,tipo:document.getElementById('fin-tipo').value,valor:parseFloat(document.getElementById('fin-valor').value)||0,metodo:'Manual',dataISO:new Date().toISOString()},btn); }
    function renderFinancas(){ const t=document.getElementById('lista-financa'); t.innerHTML=''; financas.forEach(f=>{ t.innerHTML+=`<tr><td class="ps-4"><i class="fas ${f.tipo==='entrada'?'fa-arrow-up text-success':'fa-arrow-down text-danger'}"></i></td><td>${f.desc}</td><td class="fw-bold ${f.tipo==='entrada'?'text-success':'text-danger'}">${formatCurrency(f.valor)}</td><td>${formatDate(f.dataISO)}</td><td class="text-end pe-4"><button class="btn btn-sm btn-light text-danger" onclick="del('financas','${f.id}')"><i class="fas fa-trash"></i></button></td></tr>` }); }
    
    function abrirModalOS(){ new bootstrap.Modal(document.getElementById('modalOS')).show(); }
    function salvarOS(btn){ addData("os",{cliente:document.getElementById('os-cliente').value,desc:document.getElementById('os-desc').value,valor:parseFloat(document.getElementById('os-valor').value)||0,prazo:document.getElementById('os-data').value,dataCriacao:new Date().toISOString(),concluido:false},btn); }
    function renderOS(){ const c=document.getElementById('lista-os'); c.innerHTML=''; osList.forEach(o=>{ c.innerHTML+=`<div class="col-md-4"><div class="card card-custom p-3 border-start border-4 ${o.concluido?'border-success':'border-warning'}"><h6 class="fw-bold">${o.cliente}</h6><p class="small text-muted mb-2">${o.desc}</p><div class="d-flex justify-content-between align-items-center"><span class="fw-bold text-primary">${formatCurrency(o.valor)}</span><button class="btn btn-sm btn-light text-danger" onclick="del('os','${o.id}')"><i class="fas fa-trash"></i></button></div></div></div>` }); }

    // UTILS CRUD
    async function addData(col,d,btn){ if(btn)setLoading(btn,true); await getUserRef(col).add(d); if(btn){setLoading(btn,false); bootstrap.Modal.getInstance(btn.closest('.modal')).hide(); Swal.fire({toast:true,icon:'success',title:'Salvo',position:'top-end',showConfirmButton:false,timer:1000});} }
    function del(col,id){ Swal.fire({title:'Excluir?',icon:'warning',showCancelButton:true,confirmButtonColor:'#d33'}).then(r=>{if(r.isConfirmed)getUserRef(col).doc(id).delete()}) }

    navTo('dashboard');
</script>
</body>
</html>